<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Learn Node.js :: Learn Node.js by Alex Kluew</title>
    <link rel="canonical" href="https://course.learnnodejs.dev/main/1.5/book.html">
    <meta name="generator" content="Antora 2.3.3">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-173618647-1"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','UA-173618647-1')</script>
  </head>
  <body class="article">
<script async data-uid="b7a10c8563" src="https://wondrous-experimenter-4427.ck.page/b7a10c8563/index.js"></script>
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://course.learnnodejs.dev">Learn Node.js by Alex Kluew</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://gumroad.com/l/javascript" target="_blank">Buy on Gumroad</a>
        <a class="navbar-item" href="https://leanpub.com/learnnodejs" target="_blank">Buy on LeanPub</a>
        <a class="navbar-item" href="https://twitter.com/alexkluew_dev">
          <span class="icon">
            <svg aria-hidden="true" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 512 512">
              <path fill="#57aaee"
                d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z">
              </path>
            </svg>
          </span>
        </a>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="main" data-version="1.5">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Learn Node.js</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Chapters</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="introduction.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="sequelize.js.html">Database</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="seo.html">SEO</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="maps.html">Maps</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="pagination.html">Pagination</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="users.html">Authentication and Authorization</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="deployment.html">Deployment</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Learn Node.js</span>
    <span class="version">1.5</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Learn Node.js</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">1.5</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="book.html">Learn Node.js</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/learnnodejsca/learnnodejs/edit/master/main/modules/ROOT/pages/book.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Learn Node.js</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_dedication">Dedication</a></li>
<li><a href="#_introduction">Introduction</a>
<ul class="sectlevel1">
<li><a href="#_background">1. Background</a></li>
<li><a href="#_users">2. Users</a></li>
<li><a href="#_architecture">3. Architecture</a></li>
<li><a href="#_folder_structure">4. Folder Structure</a></li>
<li><a href="#_templates">5. Templates</a>
<ul class="sectlevel2">
<li><a href="#layout-hbs">5.1. views/layout.hbs</a></li>
<li><a href="#index-hbs">5.2. views/index.hbs</a></li>
</ul>
</li>
<li><a href="#_cascading_style_sheet">6. Cascading style sheet</a></li>
<li><a href="#forms">7. Forms</a></li>
</ul>
</li>
<li><a href="#_database">Database</a>
<ul class="sectlevel1">
<li><a href="#_assumptions">8. Assumptions</a></li>
<li><a href="#_configuration">9. Configuration</a></li>
<li><a href="#_models">10. Models</a>
<ul class="sectlevel2">
<li><a href="#_modelsuser_js">10.1. models/user.js</a></li>
<li><a href="#_modelsnews_article_js">10.2. models/news_article.js</a></li>
<li><a href="#_modelsreview_js">10.3. models/review.js</a></li>
<li><a href="#_modelsresidence_js">10.4. models/residence.js</a></li>
</ul>
</li>
<li><a href="#_migrations">11. Migrations</a></li>
</ul>
</li>
<li><a href="#_seo">SEO</a>
<ul class="sectlevel1">
<li><a href="#_minimum_seo">12. Minimum SEO</a></li>
<li><a href="#_schema_org">13. Schema.org</a></li>
<li><a href="#_sitemap">14. Sitemap</a></li>
<li><a href="#_social_share_images">15. Social share images</a></li>
<li><a href="#_seo_checklist">16. SEO Checklist</a></li>
</ul>
</li>
<li><a href="#_maps">Maps</a>
<ul class="sectlevel1">
<li><a href="#_leaflet_js">17. Leaflet.js</a></li>
<li><a href="#geoJSON">18. GeoJSON</a></li>
<li><a href="#_markers_vs_clusters_plugin">19. Markers vs. Clusters plugin</a></li>
<li><a href="#_search_plugin">20. Search Plugin</a></li>
</ul>
</li>
<li><a href="#_pagination">Pagination</a></li>
<li><a href="#_authentication_and_authorization">Authentication and Authorization</a>
<ul class="sectlevel1">
<li><a href="#_secure_user_sign_in">21. Secure user sign-in</a>
<ul class="sectlevel2">
<li><a href="#_secure_user_sessions">21.1. Secure user sessions</a></li>
</ul>
</li>
<li><a href="#_secure_create_user_account">22. Secure create user account</a></li>
<li><a href="#_secure_user_password_resets">23. Secure user password resets</a></li>
<li><a href="#_user_profiles">24. User profiles</a></li>
</ul>
</li>
<li><a href="#_deployment">Deployment</a>
<ul class="sectlevel1">
<li><a href="#_ngrok_com">25. ngrok.com</a></li>
<li><a href="#_heroku">26. Heroku</a></li>
<li><a href="#_server">27. Server</a>
<ul class="sectlevel2">
<li><a href="#_colocation">27.1. Colocation</a></li>
<li><a href="#_cloud">27.2. Cloud</a></li>
<li><a href="#_running_server">27.3. Running Server</a>
<ul class="sectlevel3">
<li><a href="#_healthcheck_of_server">27.3.1. Healthcheck of Server</a></li>
<li><a href="#_healthcheck_of_databases">27.3.2. Healthcheck of Databases</a></li>
</ul>
</li>
<li><a href="#_server_setup_checklist">27.4. Server setup checklist</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="_dedication"><a class="anchor" href="#_dedication"></a>Dedication</h2>
<div class="sectionbody">
<div class="paragraph lead text-center">
<p><em>dedicated to Laura</em></p>
</div>
<div class="paragraph lead text-center">
<p>Thank you for your support and encouragement.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="_introduction" class="sect0"><a class="anchor" href="#_introduction"></a>Introduction</h1>
<div class="sect1">
<h2 id="_background"><a class="anchor" href="#_background"></a>1. Background</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Project <a href="http://elderoostalpha.herokuapp.com">“Elderoost”</a> is a full-stack senior residence application in which users can search, review, and add residence information. It was created with intention of providing useful information about a specific retirement home for future residents. Moreover, there was an aim that the application would provide a safe space for residents of these senior residences to review their living environments. Some of the general requirements that I created for this project :</p>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p><i class="fa fa-check-square-o"></i> Node.js</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> PostgreSQL database</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> SEO optimized</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Responsive design</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Fast loading times</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> JavaScript codebase</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Minimum dependencies</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Interactive maps</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Legible font</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Handlebars templates</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Fast search</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> User accounts</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Administrative Dashboard</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Comments</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Reviews</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> News Articles</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Email notifications</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Prior to beginning the project, I created several requirements. First and foremost, I wanted it to be written in JavaScript using Node.js. Next, I wanted to use the PostgreSQL database as my data storage of choice. One of the reasons for selecting PostgreSQL is that it has a wonderful PostGIS extension which makes interacting with geolocation data much easier than other solutions.</p>
</div>
<div class="paragraph">
<p>The end goal of the application would be to index well in the search engines. This is done primarily through search engine optimization (SEO) work, responsive design, and fast loading times on mobile and on desktop. To stick to these requirements, I made sure to use the minimum amount of  dependencies that I needed in order to run the project.</p>
</div>
<div class="paragraph">
<p>Moreover, I wanted the actual search to be visual and done via interactions with some sort of a map. The reason for this was simple, when searching for a new residence I wanted the user to search by area first and other information second. Map interface when it comes to searching by geographical area comes natural.</p>
</div>
<div class="paragraph">
<p>I wanted to provide to the user a secondary way of searching that was not reliant on a map. Thus, Elderoost should retrieve residence entities through textual search means and not visual alone. Next, I wanted to ensure that there were secure user accounts. This decision was two fold : (1) I wanted to keep the data and not offload it to a 3rd party social login solution, and (2) I wanted to obtain email addresses of users such that I could notify them of product updates. Thus, I also had a requirement that there would be automated notifications to the users via email.</p>
</div>
<div class="paragraph">
<p>Finally, the project should maintain some sort of an administrative dashboard to manage all of the data. Therefore, there needed to be some kind of roles implementation for authorization part of the application. A regular user shouldn’t be able to access this dashboard.</p>
</div>
<div class="paragraph">
<p>I hope that you can see similarities of this project that could be transferred to your daily JavaScript workings. Features, such as secure user accounts, are useful and are required in many modern applications.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_users"><a class="anchor" href="#_users"></a>2. Users</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Prior to going through the code, I wanted to go through the three different users in the application and their individual use cases. This provided me some guidance during the building phase of the project.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/users-usecases.png" alt="users usecases">
</div>
<div class="title">Figure 1. User use cases design</div>
</div>
<div class="paragraph">
<p>Elderoost has three types of users : (1) a guest user, (2) registered user, and (3) an admin user. I wanted the guest to use the application but be directed towards creating an account and opening an array of features once they did that. However, I understood that not everyone wants to create an account so I wanted to leave some core features available for the guest. I wanted them to be able to browse the content and to search through the content. Beyond these two tasks, the guest user should be directed to creating an account feature.</p>
</div>
<div class="paragraph">
<p>Once a user registered, they are opened up to the “default feature” list that I show in the graphic above. Besides the typical user management, the user has the ability to add more data to our project. This decision to force user accounts was made to minimize the amount of spam and increase value when compared to a guest user account.</p>
</div>
<div class="paragraph">
<p>An admin user would then have access to all of the features of the guest user and a regular user, with the added benefit of an added administrative dashboard. In the dashboard, I wanted the user to have control over the residences and news articles. However, it did not make sense to allow admin users to create reviews or submit them on someone else’s behalf. Also, the control of the users would be done solely by interacting with the database. I did not want to build an interface for this entity.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_architecture"><a class="anchor" href="#_architecture"></a>3. Architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One of the requirements for project Elderoost was to maintain the dependency list to a minimum.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="_images/overall-architecture-screen.png" alt="Project Elderoost application architecture overview">
</div>
<div class="title">Figure 2. Project Elderoost application architecture overview</div>
</div>
<div class="paragraph">
<p>Let’s take a look at the overall application architecture. I can do that through the analysis of the packages that are required to run everything. Node.js shines in the composition of different modules that bring the overall application to life. This, also, means that you have to be careful in the packages that you pick and ensure that you don’t pick an old and outdated package.</p>
</div>
<div class="paragraph">
<p>In the image above, I grouped some of the modules by their function in the application. Let’s take a look at the modules and see where each one fits in</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">express</dt>
<dd>
<p>Application server responsible for our app&#8217;s functionality</p>
</dd>
<dt class="hdlist1">path</dt>
<dd>
<p>Core node.js module that allows us to specify locations within our project</p>
</dd>
<dt class="hdlist1">cookie-parser</dt>
<dd>
<p>Parse cookies</p>
</dd>
<dt class="hdlist1">generate-password</dt>
<dd>
<p>Used to generate secure password reset token</p>
</dd>
<dt class="hdlist1">client-sessions</dt>
<dd>
<p>Module used for creation of <code>session</code> object to maintain user data and maintenance of encrypted cookie</p>
</dd>
<dt class="hdlist1">bcrypt</dt>
<dd>
<p>Used to encrypt password into a hash</p>
</dd>
<dt class="hdlist1">hbs</dt>
<dd>
<p>Handlebars templating engine that allows us to create views using hbs templating language</p>
</dd>
<dt class="hdlist1">morgan</dt>
<dd>
<p>Helps with logging</p>
</dd>
<dt class="hdlist1">helmet</dt>
<dd>
<p>Improves security of our application</p>
</dd>
<dt class="hdlist1">sendgrid/mail</dt>
<dd>
<p>Sends emails to our users</p>
</dd>
<dt class="hdlist1">sequelize</dt>
<dd>
<p>Module responsible for interactions with our database of choice</p>
</dd>
<dt class="hdlist1">pg</dt>
<dd>
<p>PostgreSQL connector</p>
</dd>
<dt class="hdlist1">pg-hstore</dt>
<dd>
<p>PostgreSQL connector</p>
</dd>
<dt class="hdlist1">csurf</dt>
<dd>
<p>Module responsible for CSRF protection and adding csrf token to our request object</p>
</dd>
<dt class="hdlist1">sitemap</dt>
<dd>
<p>Module responsible for generating a proper sitemap which is then submitted to the search engines</p>
</dd>
</dl>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_folder_structure"><a class="anchor" href="#_folder_structure"></a>4. Folder Structure</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If we take a look at how node.js application works along with the express framework, we can see a close resemblance to the <a href="https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller">model-view-controller</a> (MVC) model. Thus, the basic idea about the project’s file structure is around the MVC architecture. It feels natural to structure the project this way.</p>
</div>
<div class="imageblock right text-center">
<div class="content">
<img src="_images/folder-structure-screen.png" alt="folder structure screen" width="250">
</div>
<div class="title">Figure 3. Node.js app simplified</div>
</div>
<div class="paragraph">
<p>When a client opens up a web browser and types in the app’s URL, our express web-server catches the request and passes on to its router object. Here in the process express framework does a check if the URL is good and we can proceed, or it is a bad URL and an error is spit back out to the user. The diagram on the left assumes a correct user-flow.</p>
</div>
<div class="paragraph">
<p>The router then looks at the appropriate route handler to pass on the request. In our case, our route handlers are conveniently located in the <code>/routes</code> folder of the project.</p>
</div>
<div class="paragraph">
<p>From the router handler, our app can interact with our models that are located in our database and then pass this data on to the handlebars view. However, the handler doesn’t necessarily interact with our models and it can just send a response with a specific handlebars view.</p>
</div>
<div class="paragraph">
<p>And finally, the response is sent to the client.</p>
</div>
<div class="paragraph">
<p>Within our project, then JavaScript code that is pertinent to interacting with models is placed in the <code>/models</code> folder; code that is the core business logic, is placed in the <code>/routes</code> folder; and our views are placed in the <code>/views</code> folder.</p>
</div>
<div class="paragraph">
<p>The finished folder structure looks like this :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">.
├── app.js <i class="conum" data-value="1"></i><b>(1)</b>
├── config <i class="conum" data-value="2"></i><b>(2)</b>
│   ├── db.js
│   ├── db.seed.js
│   ├── sitemap-list-of-urls.txt
│   └── sitemap.xml
├── models <i class="conum" data-value="3"></i><b>(3)</b>
│   ├── news_article.js
│   ├── residence.js
│   ├── review.js
│   └── user.js
├── package.json
├── public <i class="conum" data-value="4"></i><b>(4)</b>
│   ├── images
│   ├── javascripts
│   │   ├── fuse
│   │   │   └── fuse.min.js
│   │   ├── images
│   │   │   ├── search.png
│   │   │   └── search_input.png
│   │   ├── leaflet
│   │   │   └── leaflet.min.js
│   │   ├── leaflet-fusesearch
│   │   │   ├── leaflet.fusesearch.css
│   │   │   └── leaflet.fusesearch.js
│   │   └── leaflet-markercluster
│   │       └── leaflet.markercluster.js
│   ├── sitemap.xml.gz
│   └── stylesheets
│       └── style.css
├── routes <i class="conum" data-value="5"></i><b>(5)</b>
│   ├── dashboard.js
│   ├── index.js
│   ├── residences.js
│   └── users.js
└── views <i class="conum" data-value="6"></i><b>(6)</b>
│   ├── dashboard
│   ├── residences
│   ├── static
│   ├── users
│   ├── error.hbs
│   ├── index.hbs
│   └── layout.hbs</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>app.js</code> starts the entire application</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>folder in which all of the configurations go. In this case, I only have the database configuration file, the database seed file, and 2 files which are related to the generation of sitemap</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>folder in which all of the models reside</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>folder contains assets that I want my app to use during production. I further separated by creating an <code>images</code>, <code>javascript</code>, and <code>stylesheets</code> folders in order to create separate places to place similar format files.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>folder contains the router handler logic for specific sections of the app</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>folder contains the user interface screens for the application</td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_templates"><a class="anchor" href="#_templates"></a>5. Templates</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Project Elderoost uses <a href="https://handlebarsjs.com/">handlebars</a> (hbs) templating language for displaying its HTML content. Handlebars is super easy to learn and get a hang off. It is one of the choices among several for the express viewing engine. I wont focus on the specifics and leave that up to you for some play. However, I believe that by going through the book and looking at the sample code you will be able to get the gist of the language without needing to look elsewhere.</p>
</div>
<div class="paragraph">
<p>The way that the templates work is that there is a generic <code>layout.hbs</code> file which handles the overall template for your application. This is where you would insert your <code>html</code>, <code>css</code>, or <code>javascript</code> import script statements. The actual, default, location for views that will be displayed using this <code>layout.hbs</code> is located in the <code>views</code> folder.</p>
</div>
<div class="paragraph">
<p>The templates themselves are written in the handlebars templating language which is basically a superset of HTML. Each template file ends in <code>.hbs</code> file extension. For example, <code>views/index.hbs</code> is the main screen for the project.</p>
</div>
<div class="paragraph">
<p>The main take away for the hbs templating language is that it uses curly braces <code>{{ somevariable }}</code> to evaluate javascript in its code. For example, suppose the following function is supposed to render a residence template and I set a variable that will be accessible in a template. To do this, simply pass on your variable as an object to the <code>res.render</code> function, like so :</p>
</div>
<div class="listingblock">
<div class="title">route.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">async function (req,res,next) {
  const id = req.id;
  const residence = await Residence.findOne({where: {id: `id`}}); <i class="conum" data-value="1"></i><b>(1)</b>
  const data = { residence: residence };

  res.render('residence', data);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>I assume that the residence object in the code above has address property that tells you where the residence is located.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then, in your <code>residence.hbs</code> template file, you would simply catch the javascript object and unwrap its value to be used however you want. For example, suppose we just want to catch the variable and print the residence’s address property. I would do it like so :</p>
</div>
<div class="listingblock">
<div class="title">residence.hbs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;p&gt; Residence is located at {{residence.address}} &lt;/p&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the code above would generate HTML output with the value that is set on our residence object’s address property. Simple!</p>
</div>
<div class="paragraph">
<p>The other two useful demonstrations of the templating language would be : (1) conditionals and (2) loops. <a href="https://handlebarsjs.com/guide/builtin-helpers.html">Conditionals</a> only execute the code if the variable in the expression is available to the template and are executed like so :</p>
</div>
<div class="listingblock">
<div class="title">residence.hbs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">{{#if residence}}
&lt;p&gt; Residence is located at {{residence.address}} &lt;/p&gt;
{{/endif}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When working with loops, when you have a collection of data, the syntax is a bit different and looks like so :</p>
</div>
<div class="listingblock">
<div class="title">residence.hbs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">{{#each residences as |residence|}}
&lt;p&gt; Residence is located at {{address}} &lt;/p&gt;
{{/each}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The difference lies in the fact that you don’t need to prepend <em>residence</em> object to the evaluating expression. Simply pass in the appropriate property that you want displayed.</p>
</div>
<div class="paragraph">
<p>The last thing that I want to cover is the two types of templates that typically exist in a project. Dynamic There are two types of templates in the project : (1) static content that rarely changes, and (2) dynamic content that gets generated per request.</p>
</div>
<div style="page-break-after: always;"></div>
<div class="sect2">
<h3 id="layout-hbs"><a class="anchor" href="#layout-hbs"></a>5.1. views/layout.hbs</h3>
<div class="paragraph">
<p>In addition to the <a href="seo.html#layout-head" class="page">head</a> code that I insert into my layout, I also add the following main navigation section that looks different depending on the type of the user and whether or not the user is logged in. It looks something like this:</p>
</div>
<div id="layout-navigation" class="listingblock">
<div class="title">views/layout.hbs navigation bar code</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;body&gt;
  &lt;header class="header"&gt;
    &lt;nav class="navbar"&gt;
      &lt;div class="navbar__branding"&gt;
        &lt;span class="navbar__branding__title"&gt;&lt;a href="/?ref=navbar" class="navbar__branding__title__action"&gt;ELDEROOST&lt;/a&gt;&lt;/span&gt;
      &lt;/div&gt;
      &lt;ul class="navbar__actions"&gt;
        &lt;li class="navbar__actions__list"&gt;&lt;a href="/residences?ref=nav" class="navbar__actions__list__item"&gt;Explore&lt;/a&gt;
        &lt;/li&gt;
        &lt;li class="navbar__actions__list"&gt;&lt;a href="/about?ref=nav" class="navbar__actions__list__item"&gt;About&lt;/a&gt;
        &lt;/li&gt;
        &lt;li class="navbar__actions__list"&gt;&lt;a href="/search?ref=nav" class="navbar__actions__list__item"&gt;Search&lt;/a&gt;
        &lt;/li&gt;
        {{#if user}} <i class="conum" data-value="1"></i><b>(1)</b>
        {{#if user.is_admin}} <i class="conum" data-value="2"></i><b>(2)</b>
        &lt;li class="navbar__actions__list"&gt;&lt;a href="/dashboard?ref=nav" class="navbar__actions__list__item"&gt;Dashboard&lt;/a&gt;
        &lt;/li&gt;
        {{/if}}
        &lt;li class="navbar__actions__list"&gt;&lt;a href="/users/profile?ref=nav" class="navbar__actions__list__item"&gt;Profile&lt;/a&gt;
        &lt;/li&gt;
        &lt;li class="navbar__actions__list"&gt;&lt;a href="/users/logout?ref=nav" class="navbar__actions__list__item"&gt;Logout&lt;/a&gt;
        &lt;/li&gt;
        {{else}} <i class="conum" data-value="3"></i><b>(3)</b>
        &lt;li&gt;&lt;a href="/users/signin?ref=nav" class="button reversed-is-primary navbar__actions__list__item-remove-underline" rel="nofollow" aria-label="Login to Elderoost" title="Login to Elderoost"&gt;Login&lt;/a&gt;
        &lt;/li&gt;
        {{/if}}
      &lt;/ul&gt;
    &lt;/nav&gt;
  &lt;/header&gt;
  {{{body}}} <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>If a user is logged in they get option to view their profile and to logout</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>If a user is admin, they also get link to Dashboard</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Otherwise, a guest user only sees Login link (in addition to Explore, About, and Search)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The content of each template will be inserted into here by the templating engine</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>What follows after the header, navigation, and body is simply the footer content for the template :</p>
</div>
<div id="layout-footer" class="listingblock">
<div class="title">views/layout.hbs footer template code left section</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">  &lt;footer class="footer"&gt;
    &lt;div class="footer__interactions"&gt;
      &lt;ul class="footer__actions"&gt;
        {{#if user}} <i class="conum" data-value="1"></i><b>(1)</b>
        &lt;li&gt;&lt;a href="/users/logout?ref=footer" class="footer__actions__action" aria-label="Logout from Elderoost" title="Logout from Elderoost"&gt;Logout&lt;/a&gt;
        &lt;/li&gt;
        {{else}} <i class="conum" data-value="2"></i><b>(2)</b>
        &lt;li&gt;&lt;a href="/users/signin?ref=footer" class="footer__actions__action" aria-label="Login to Elderoost" title="Login to Elderoost"&gt;Login&lt;/a&gt;
        &lt;/li&gt;
        {{/if}}
        &lt;li&gt;&lt;a href="/about?ref=footer" class="footer__actions__action" aria-label="What is Elderoost?" title="What is Elderoost?"&gt;What is Elderoost?&lt;/a&gt;
        &lt;/li&gt;
        &lt;li&gt;&lt;a href="/privacy?ref=footer" class="footer__actions__action" aria-label="Privacy Policy" title="Privacy Policy"&gt;Privacy Policy&lt;/a&gt;
        &lt;/li&gt;
        &lt;li&gt;&lt;a href="/tos?ref=footer" class="footer__actions__action" aria-label="Terms of Use" title="Terms of Use"&gt;Terms of Use&lt;/a&gt;
        &lt;/li&gt;
      &lt;/ul&gt;
    &lt;/div&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>If user is logged in, show logout function</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Else, if a guest user then show login function</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">views/layout.hbs footer template code center social icons</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">    &lt;div class="footer__interactions-secondary"&gt;
      &lt;div&gt;&lt;span class="navbar__branding__title"&gt;ELDEROOST&lt;/span&gt;&lt;small&gt;© 2017-2020&lt;/small&gt;&lt;/div&gt;
      &lt;div&gt;
        &lt;ul class="footer__interactions-secondary__social"&gt;
          &lt;li class="footer__interactions-secondary__social__list"&gt;&lt;a href="https://twitter.com/Elderoost" class="footer__interactions-secondary__social__list__action" target="_blank" aria-label="Follow us on Twitter" title="Follow us on Twitter"&gt;&lt;i class="fa fa-twitter-square" aria-hidden="true"&gt;&lt;/i&gt;&lt;/a&gt;
          &lt;/li&gt; <i class="conum" data-value="1"></i><b>(1)</b>
          &lt;li class="footer__interactions-secondary__social__list"&gt;&lt;a href="https://instagram.com/Elderoost" class="footer__interactions-secondary__social__list__action" target="_blank" aria-label="Follow us on Instagram" title="Follow us on Instagram"&gt;&lt;i class="fa fa-instagram" aria-hidden="true"&gt;&lt;/i&gt;&lt;/a&gt;
          &lt;/li&gt; <i class="conum" data-value="2"></i><b>(2)</b>
          &lt;li&gt;&lt;a href="https://www.facebook.com/Elderoost" class="footer__interactions-secondary__social__list__action" target="_blank" aria-label="Follow us on Facebook" title="Follow us on Facebook"&gt;&lt;i class="fa fa-facebook-square" aria-hidden="true"&gt;&lt;/i&gt;&lt;/a&gt;
          &lt;/li&gt; <i class="conum" data-value="3"></i><b>(3)</b>
        &lt;/ul&gt;
      &lt;/div&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Twitter</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Instagram</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Facebook</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">views/layout.hbs footer template code right studio link</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">      &lt;div&gt;
        &lt;small&gt;Another &lt;a href="https://getaclue.me" class="footer__interactions-secondary__social__list__action" title="Go to Alex Kluew"&gt;&lt;strong&gt;getaclue&lt;/strong&gt;&lt;/a&gt; Production&lt;/small&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/footer&gt;
&lt;/body&gt;</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Download completed <code>views/layout.hbs</code> code</div>
<div class="paragraph">
<p>Looking for <code>views/layout.hbs</code> completed code? Download complementary <code>views/layout.hbs</code> code <a href="https://bit.ly/2VlBOvZ">here</a>.</p>
</div>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="index-hbs"><a class="anchor" href="#index-hbs"></a>5.2. views/index.hbs</h3>
<div class="paragraph">
<p>For this file we first begin by loading the dependencies to constructing our leaflet map. In our project it is a combination of provided library code and external calls. Feel free to modify this code as you wish just ensure the library versions are the same. I noticed at one point that some libraries do not jive well if some libraries are running on the latest everything. I recommend using the libraries provided with this book. The code looks like :</p>
</div>
<div class="listingblock">
<div class="title">views/index.hbs beginning code piece</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
  integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
  crossorigin="" /&gt;
&lt;script src="/javascripts/leaflet/leaflet.min.js"&gt;&lt;/script&gt;
&lt;link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" crossorigin="" /&gt;
&lt;link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"
  crossorigin="" /&gt;
&lt;script src="/javascripts/leaflet-markercluster/leaflet.markercluster.js" crossorigin=""&gt;&lt;/script&gt;
&lt;script src="/javascripts/fuse/fuse.min.js"&gt;&lt;/script&gt;
&lt;link rel="stylesheet" href="/javascripts/leaflet-fusesearch/leaflet.fusesearch.css" /&gt;
&lt;script src="/javascripts/leaflet-fusesearch/leaflet.fusesearch.js" crossorigin=""&gt;&lt;/script&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>I would copy paste the code at this point as we will look at these modules in greater detail at different points of this book. What follows next is a conditional code block that displayes latest residence updates, if there are any to display. When is a case that there is nothing to display? If you are using a custom query or if it is a brand new project =) Otherwise, it is just a precaution and the code looks like this :</p>
</div>
<div class="listingblock">
<div class="title">views/index.hbs code continuation</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;section class="main main-text-wrapper" style="padding-bottom:0"&gt;
  &lt;div class="main__wrapper-purple padding-left padding-right"&gt;
    &lt;h1 class="main__wrapper-purple__text"&gt;
      Explore senior care residences near you
    &lt;/h1&gt;
  &lt;/div&gt;
  {{#if residences}}
  &lt;div class="main__wrapper main__negative-top-margin" style="max-width:964px;border:1px solid #344e86;"&gt;
    &lt;div class="padding-left padding-right"&gt;
      &lt;h3 style="display:flex;align-items:center;"&gt;&lt;i class="fas fa-address-card fa__mod"
          aria-hidden="true"&gt;&lt;/i&gt;&amp;nbsp;Recently updated residences&lt;/h3&gt;
      &lt;ul class="main__wrapper__list"&gt;
        {{#each residences as |residence|}}
        &lt;li class="main__wrapper__list__item"&gt;&lt;a class="main__wrapper__link"
            href="/residences/{{slug}}?ref=recently_updated"&gt;{{name}}&lt;/a&gt;&lt;br&gt;&lt;em&gt;{{address_city}},
            {{address_state}}&lt;/em&gt;
        &lt;/li&gt;
        {{/each}}
      &lt;/ul&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  {{/if}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>After that code, we begin the custom map construction of the area and the side button controls that take you quickly to a specific province</p>
</div>
<div class="listingblock">
<div class="title">views/index.hbs map construction beginning</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;div class="main__wrapper-main-map" style="border-radius:5px;max-width:964px;border:1px solid #344e86;"&gt;
  &lt;div class="padding-left padding-right"&gt;
    &lt;p class="main__text-small"&gt;&lt;i class="fa fa-info-circle" aria-hidden="true"&gt;&lt;/i&gt; Drag around the map to find
      elderly care residences in your region.&lt;/p&gt;
  &lt;/div&gt;
  &lt;div class="main__wrapper-main-map-with-filter"&gt;
    &lt;div class="main__wrapper-main-map-with-filter__wrapper"&gt;
      &lt;small&gt;&lt;strong&gt;Filter by Province&lt;/strong&gt;&lt;/small&gt;
      &lt;ul class="main__wrapper__list-filter"&gt;
        &lt;li class="main__wrapper__list__item-filter"&gt;&lt;button class="main__wrapper__list__item-filter__button"type="button" name="jump-to-BC"&gt;BC&lt;/button&gt;&lt;/li&gt; <i class="conum" data-value="1"></i><b>(1)</b>
        &lt;li class="main__wrapper__list__item-filter"&gt;&lt;button class="main__wrapper__list__item-filter__button" type="button" name="jump-to-AB"&gt;AB&lt;/button&gt;&lt;/li&gt;
        &lt;li class="main__wrapper__list__item-filter"&gt;&lt;button class="main__wrapper__list__item-filter__button" type="button" name="jump-to-SK"&gt;SK&lt;/button&gt;&lt;/li&gt;
        &lt;li class="main__wrapper__list__item-filter"&gt;&lt;button class="main__wrapper__list__item-filter__button" type="button" name="jump-to-MB"&gt;MB&lt;/button&gt;&lt;/li&gt;
        &lt;li class="main__wrapper__list__item-filter"&gt;&lt;button class="main__wrapper__list__item-filter__button" type="button" name="jump-to-ON"&gt;ON&lt;/button&gt;&lt;/li&gt;
        &lt;li class="main__wrapper__list__item-filter"&gt;&lt;button class="main__wrapper__list__item-filter__button" type="button" name="jump-to-QC"&gt;QC&lt;/button&gt;&lt;/li&gt;
        &lt;li class="main__wrapper__list__item-filter"&gt;&lt;button class="main__wrapper__list__item-filter__button" type="button" name="jump-to-NB"&gt;NB&lt;/button&gt;&lt;/li&gt;
        &lt;li class="main__wrapper__list__item-filter"&gt;&lt;button class="main__wrapper__list__item-filter__button" type="button" name="jump-to-PEI"&gt;PEI&lt;/button&gt;&lt;/li&gt;
        &lt;li class="main__wrapper__list__item-filter"&gt;&lt;button class="main__wrapper__list__item-filter__button" type="button" name="jump-to-NS"&gt;NS&lt;/button&gt;&lt;/li&gt;
        &lt;li class="main__wrapper__list__item-filter"&gt;&lt;button class="main__wrapper__list__item-filter__button" type="button" name="jump-to-NL"&gt;NL&lt;/button&gt;&lt;/li&gt;
      &lt;/ul&gt;
    &lt;/div&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Province short code button to jump on the map on press</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then we procede to construct the map itself</p>
</div>
<div id="index-hbs-map" class="listingblock">
<div class="title">views/index.hbs map construction</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;div id="map" class="map main__wrapper-main-map-with-filter" style="width:100%;"&gt;
  &lt;script type="text/javascript"&gt;
  !function(e){L.tileLayer("https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png",{attribution:`&amp;copy; &lt;a href="http://osm.org/copyright"&gt;OpenStreetMap&lt;/a&gt; contributors, &amp;copy; &lt;a
      href="https://carto.com/attribution" &gt; CARTO&lt;/a&gt; `}).addTo(e),document.addEventListener("DOMContentLoaded",function(){try{let a=fetch('/residences/api').then(result=&gt;result.json()).then(data=&gt;{ <i class="conum" data-value="1"></i><b>(1)</b>
        const t=L.geoJSON(data,{pointToLayer:function(e,t){return L.marker(t)},onEachFeature:function(e,t){e.layer=t;t.bindPopup("&lt;div&gt;&lt;h3&gt;"+e.properties.name+"&lt;/h3&gt;&lt;span&gt;"+`&lt;i class="fa fa-map-marker fa__mod" aria-hidden="true"&gt;&lt;/i&gt;&amp;nbsp;`+e.properties.address+'&lt;/span&gt;&lt;br&gt;&lt;a href="/residences/'+e.properties.slug+'?ref=home_map_popup"&gt;View details&lt;/a&gt;&lt;/div&gt;') <i class="conum" data-value="2"></i><b>(2)</b>
      }});var n=L.markerClusterGroup({chunkedLoading:!0,showCoverageOnHover:!1});n.addLayer(t);e.addLayer(n);const i={_map:e,position:"topleft",title:"Search",panelTitle:"",placeholder:"Search",caseSensitive:!1,threshold:.5,maxResultLength:null,showResultFct:null,showInvisibleFeatures:!0};var o=L.control.fuseSearch(i);o.indexFeatures(data,["name","address"]);<i class="conum" data-value="3"></i><b>(3)</b>
      e.addControl(o)});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>API</code> end point for our <a href="maps.html#geoJSON" class="page">geoJSON</a> <a href="maps.html#geoJSON-data" class="page">data</a> we request during map construction</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Popup on each marker that gives you a link to the specific residence based on their slug</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Index fuse search plugin using <code>name</code> and <code>address</code> properties of each residence</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">views/index.hbs map controls for prinvinces on click binding construction</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">document.getElementsByName("jump-to-QC")[0].addEventListener("click",function(){e.setView([45.593,-73.504],7)}),document.getElementsByName("jump-to-ON")[0].addEventListener("click",function(){e.setView([43.606,-79.843],7)}),document.getElementsByName("jump-to-NB")[0].addEventListener("click",function(){e.setView([46.61,-65.945],7)}),document.getElementsByName("jump-to-NS")[0].addEventListener("click",function(){e.setView([45.056,-63.397],7)}),document.getElementsByName("jump-to-PEI")[0].addEventListener("click",function(){e.setView([46.288,-63.419],7)}),document.getElementsByName("jump-to-NL")[0].addEventListener("click",function(){e.setView([47.475,-52.85],6)}),document.getElementsByName("jump-to-MB")[0].addEventListener("click",function(){e.setView([51.382,-98.811],7)}),document.getElementsByName("jump-to-SK")[0].addEventListener("click",function(){e.setView([51.669,-106.622],7)}),document.getElementsByName("jump-to-AB")[0].addEventListener("click",function(){e.setView([53.55,-113.994],6)}),document.getElementsByName("jump-to-BC")[0].addEventListener("click",function(){e.setView([53.403,-126.387],5)<i class="conum" data-value="1"></i><b>(1)</b>
})}catch(t){let n=L.marker([43.6426,-79.3871]).addTo(e);e.setView([43.6426,-79.3871],13),n.bindPopup(`Oops, looks like we had a problem loading the map
=(&lt;br&gt;&lt;strong&gt;But,do not worry!&lt;/strong&gt;&lt;br&gt;You can still &lt;a href="/search?ref=home_map_popup_failed" class="main__wrapper__link"&gt;Search&lt;/a&gt; or &lt;a href="/search?ref=home_map_popup_failed" class="main__wrapper__link"&gt;Switch to list view&lt;/a&gt;.`).openPopup() console.error(`error : `,t)}})}(L.map("map",{scrollWheelZoom:!1}).setView([45.416191,-75.691727],5))&lt;/script&gt;
&lt;/div&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In the code above we bind on click events that activate the buttons for each province click. <code>e</code> is the identifier for our map; <code>setView</code> is the function that changes where the map will be changed its view to based on input of <code>[53.55,-113.994],6</code> or an array and a number. Whenever a user clicks on the province short code, the map changes the location based on the coordinates provided above. Thus, this code show you how to interact with a map using external html elements like a button.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We finish off the template with a link to our residences in a list manner, in a table view; like so :</p>
</div>
<div class="listingblock">
<div class="title">views/index.hbs finishing code with a link to table list view</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">    &lt;/div&gt;
    &lt;div style="display:flex; align-items:center; padding:1em;"&gt;
      &lt;h3 style="padding-right:1em;"&gt;Not a fan of maps? &lt;i class="fa fa-arrow-circle-right" aria-hidden="true"
          style="padding-left:0.5em"&gt;&lt;/i&gt;&lt;/h3&gt;
      &lt;a href="/residences?ref=main_page" style="flex-grow:1" class="button
      is-primary button__wrapper__a-remove-underline"&gt;View directory&lt;/a&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;div class="main__wrapper-main-map padding-left padding-right"
    style="flex-direction: row; justify-content: space-around; align-items: center; margin-bottom:0;"&gt;
    &lt;h2&gt;Are we missing a residence?&lt;/h2&gt;
    &lt;a href="/residences/suggest-new?ref=main-page" class="button button__wrapper__a-remove-underline"
      aria-label="Add a missing residence" title="Add a Residence"&gt;Suggest a missing residence&lt;/a&gt;
  &lt;/div&gt;
&lt;/section&gt;</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Download completed <code>views/index.hbs</code> code</div>
<div class="paragraph">
<p>Looking for completed <code>views/index.hbs</code> code? Download complementary <code>views/index.hbs</code> code  <a href="https://bit.ly/2zbtd6h">here</a>.</p>
</div>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cascading_style_sheet"><a class="anchor" href="#_cascading_style_sheet"></a>6. Cascading style sheet</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Project Elderoost was designed with <a href="https://webaim.org/resources/contrastchecker/">WCAG 2.0 AAA</a> color palette in mind. If you have suggestions or improvements, feel free to reach out and contact me.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Download custom css</div>
<div class="paragraph">
<p>Feel free to download the custom <strong>css</strong> file and use this custom style sheet located <a href="https://bit.ly/34SaDw4">here</a> in your project.</p>
</div>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/style-sheet-screen.png" alt="gist.github.com link to custom Elderoost css">
</div>
<div class="title">Figure 4. Download free Elderoost custom style sheet on private gist.github.com link.</div>
</div>
<div class="paragraph">
<p>I used Block, Element, Modifier (BEM) css style convention for my naming of css variables. You can read more about BEM <a href="https://css-tricks.com/bem-101/">here</a>. For some backgrounds I used <a href="http://www.heropatterns.com/">hero patterns</a>.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="forms"><a class="anchor" href="#forms"></a>7. Forms</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I am going to assume for the duration of the project that you are aware about one of the most common security flaws for a website : cross site request forgery (csrf).<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup> In order to mitigate this attack, we are going to use the <code>csurf</code> node.js module. We first add it in our <code>routes/users.js</code> file like so</p>
</div>
<div class="listingblock">
<div class="title">routes/users.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">...
const csrf = require('csurf'); <i class="conum" data-value="1"></i><b>(1)</b>
const csrfProtection = csrf({ cookie: true }); <i class="conum" data-value="2"></i><b>(2)</b>
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>import the csurf module</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>set the token mechanism to be initialized and to be ready to be passed along via cookies</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then, we simply focus on how to use it. We need to use the <code>csrfProtection</code> function in our routers as needed.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>case one:</p>
<div class="paragraph">
<p>for <code>get</code> router handlers, by adding <code>csrfProtection</code> function handler gives the request object <code>csrfToken()</code> function that passes on a csrf token to be used by a form.</p>
</div>
</li>
<li>
<p>case two:</p>
<div class="paragraph">
<p>for <code>post</code> router handlers, <code>csrfProtection</code> function ensures that the csrf token matches from the form data. If the token does not match, then the router handler throws an error and everything stops.</p>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Case one : <code>get</code> router in routes/users.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">...
router.get('/signin', csrfProtection, (req, res, next) =&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
  res.render('users/sign-in', {
    title: `Login - Elderoost`,
    csrfToken: req.csrfToken(), <i class="conum" data-value="2"></i><b>(2)</b>
  });
});
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Attach <code>csrfProtection</code> to the <code>/signin</code> <code>get</code> route</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Pass <code>csrfToken</code> variable to the <code>views/users/sign-in.hbs</code> template to be used as a hidden input in a form</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Case two : <code>post</code> router in routes/users.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">...
router.post('/signin', csrfProtection, async (req, res, next) =&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
  const { email, password } = req.body;
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>By attaching <code>csrfProtection</code> route handler, this router handler now expects a csrf token to be passed along with other information</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Moving forward I will assume that you will understand where the csrf token is coming from in various sections of the application.</p>
</div>
</div>
</div>
<h1 id="_database" class="sect0"><a class="anchor" href="#_database"></a>Database</h1>
<div class="sect1">
<h2 id="_assumptions"><a class="anchor" href="#_assumptions"></a>8. Assumptions</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Sequelize is a promise-based Node.js ORM for Postgres, MySQL, MariaDB, SQLite and Microsoft SQL Server.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Sequelize API Reference<br>
<cite>https://sequelize.org/v5/</cite>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>I assume that the database of choice, if different from <a href="https://www.postgresql.org/">PostgreSQL</a>, is setup.</p>
</li>
<li>
<p>Also, I assume that we will be using <a href="https://sequelize.org">sequelize.js</a> for the database communication layer.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>What is great about sequelize is that it does not care about your underlying database. If database is supported, then you can switch databases by adjusting the configuration file and your code will mostly work the same.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="_images/sequelize-workings.png" alt="Sequelize working with PostgreSQL and SQLite">
</div>
<div class="title">Figure 5. Sequelize working with PostgreSQL and SQLite</div>
</div>
<div class="paragraph">
<p>For this project, we will be using PostgreSQL database as our data storage. Moreover, we will use <a href="https://tableplus.com/">TablePlus</a> to interact with the raw data.<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup> For setup on a mac, I recommend you do it through the <a href="https://postgresapp.com/">Postgres.app</a>. For windows platform, I recommend you install the database using their <a href="https://www.postgresql.org/download/windows/">installer</a>.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration"><a class="anchor" href="#_configuration"></a>9. Configuration</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="title">Install sequelize and the required postgresql modules</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">npm install --save sequelize
npm install --save pg pg-hstore</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, we need to describe where it is that our database is located and how to connect to it. I made a folder called <code>config</code> and a file for database <code>db.js</code>. In the file I wrote the following:</p>
</div>
<div id="database-setup" class="listingblock">
<div class="title">config/db.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">const Sequelize = require('sequelize');

var database = `postgres://getaclue@localhost:5432/elderoostalpha_dev`; <i class="conum" data-value="1"></i><b>(1)</b>
var sequelize = {};

if (process.env.NODE_ENV === 'production') {
  database = `${process.env.DATABASE_URL}`; <i class="conum" data-value="2"></i><b>(2)</b>
}

sequelize = new Sequelize(`${database}`);

module.exports = sequelize;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Default postgresql connector and location if installed using <a href="https://postgresapp.com/">Postgres.app</a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>In production, I use environmental variables for my database url</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The configuration above basically follows the readme of the <a href="https://sequelize.org/v5/manual/getting-started.html">sequelize</a> project. We are injecting the sequelize project, then we are instantiating a sequelize object that will use postgresql as its database. We then glue our database code like the following code in the <code>app.js</code> file (our start file) :</p>
</div>
<div class="listingblock">
<div class="title">app.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">...
const sequelize = require('./config/db'); <i class="conum" data-value="1"></i><b>(1)</b>
...
sequelize
  .authenticate() <i class="conum" data-value="2"></i><b>(2)</b>
  .then(() =&gt; {
    console.log('Connection has been established successfully.'); <i class="conum" data-value="3"></i><b>(3)</b>
  })
  .catch((err) =&gt; {
    console.error('Unable to connect to the database:', err); <i class="conum" data-value="4"></i><b>(4)</b>
  });
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Import sequelize as we have configured it in <code>./config/db.js</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Run the module and authenticate our connection</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>If everything works, then we get this message</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Otherwise, we get this error message with the error</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There, our database is connected and it is started every time our node.js application starts because the code is placed in our <code>app.js</code> file.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_models"><a class="anchor" href="#_models"></a>10. Models</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_modelsuser_js"><a class="anchor" href="#_modelsuser_js"></a>10.1. models/user.js</h3>
<div class="paragraph">
<p>To interact with the database, we better start off with modeling our data as per <a href="https://sequelize.org/v5/manual/getting-started.html">sequelize</a> documents. I did it by creating the following file in the folder <code>models</code> :</p>
</div>
<div class="listingblock">
<div class="title">Create models/user.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">mkdir models
cd models
touch user.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>With sequelize, you simply using their functions as they are outlined in the documentation to describe your data. I then created the following code in the <code>user.js</code> file. Since I was using underscored convention for my database structure, I set <code>underscored</code> to <code>true</code>. This makes it so that the column names are <a href="https://en.wikipedia.org/wiki/Snake_case">snake cased</a>. If this setting was left to false (default), sequelize follows JavaScript conventions for attributes: <code>residenceId</code> and not <code>residence_id</code> as I modelled it.</p>
</div>
<div class="listingblock">
<div class="title">models/user.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">const Sequelize = require('sequelize'); <i class="conum" data-value="1"></i><b>(1)</b>
const sequelize = require('../config/db');
const User = sequelize.define('user',{
    id: {type: Sequelize.UUID,allowNull: false,primaryKey: true,defaultValue: Sequelize.UUIDV4},
    email: {type: Sequelize.STRING,allowNull: false,unique: true},
    username: {type: Sequelize.STRING,allowNull: false,unique: true},
    password: {type: Sequelize.STRING,allowNull: false},
    is_admin: {type: Sequelize.BOOLEAN,allowNull: false,defaultValue: false},
    reset_password_token: {type: Sequelize.STRING,allowNull: true,unique: true}
  },{underscored: true}
);
module.exports = User;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Sequelize module is imported to aid in model definition for the variable type</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally, to test all of the code running together I need to interact with the database. I will do so by creating a seed file and running it locally. I use a similar approach for hard resets on my production. The seed file contains the bare minimum data to get the project up and running.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">touch ../config/db.seed.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the seed file I want to connect to the database and add one user to the database (the administrator) and save it. After doing that, I want to run my project again to ensure that the connection to the database is established.</p>
</div>
<div class="listingblock">
<div class="title">config/db.seed.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">const db = require("./db"); <i class="conum" data-value="1"></i><b>(1)</b>
const User = require("../models/user"); <i class="conum" data-value="2"></i><b>(2)</b>

const seed = async () =&gt; {
  await db.sync({ force: true }); <i class="conum" data-value="3"></i><b>(3)</b>

  const password = `M&lt;gC4['Dqv}G''X"Tg5XDbVrmWR16/ca`;
  const username = "getaclue";
  const email = "info@getaclue.me";
  const reset_password_token = `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwibmFtZSI6ImluZm9AZ2V0YWNsdWUubWUiLCJpYXQiOjE1MTYyMzkwMjJ9.\_lImbjluzsOJSy-hlDzEOasZRSd8YuQ_9hBmmCvSvp0`;

  User.create({
    password: password,
    email: email,
    username: username,
    reset_password_token: token,
    is_admin: true,
  })
    .then((user) =&gt; {
      <i class="conum" data-value="4"></i><b>(4)</b>
      console.log("seeded user", user);
    })
    .catch((error) =&gt; {
      console.error("failed to seed, ", error);
      db.close();
    });
};

seed();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Import database setup</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Grab the user model representation</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Reset the database by dropping all of the tables</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Return the saved user data</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Whenever you run <code>database.sync({ force: true });</code> or <code>User.sync({ force: true });</code> all of the data will be dropped in the process. In the case of the database, all of the tables will be dropped before being re-created. In the case of <code>User</code> entity, only the <code>user</code> database will be dropped and re-created.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Once everything is typed out, you can feel free to test everything once again. I ran the follow commands and made sure everything worked as expected.</p>
</div>
<div class="listingblock">
<div class="title">Test seed file followed by testing the overall connection</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">node config/db.seed.js
node app.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>I have installed <a href="https://sequelize.org/v5/manual/getting-started.html">sequelize</a> and postgreSQL in my ExpressJS project; established the connection between ExpressJS and the database via <a href="https://sequelize.org/v5/manual/getting-started.html">sequelize</a>; created User&#8217;s table, added some data, and queried that data. From here on, steps like building out the api; authentication; and authorization can proceed.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="_modelsnews_article_js"><a class="anchor" href="#_modelsnews_article_js"></a>10.2. models/news_article.js</h3>
<div class="imageblock">
<div class="content">
<img src="_images/newsarticle-model-screenshot.png" alt="NewsArticle model in user interface">
</div>
<div class="title">Figure 6. NewsArticle model in user interface</div>
</div>
<div class="listingblock">
<div class="title">models/news_article.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">const Sequelize = require('sequelize');
const sequelize = require('../config/db');

const NewsArticle = sequelize.define('news_article',{
    id: {type: Sequelize.UUID,allowNull: false,defaultValue: Sequelize.UUIDV4,primaryKey: true},
    author_names: {type: Sequelize.STRING},
    headline: {type: Sequelize.STRING},
    publisher: {type: Sequelize.STRING},
    url: {type: Sequelize.STRING},
    status: {type: Sequelize.STRING,allowNull: false,defaultValue: `pending`},publication_date: {type: Sequelize.DATE},
    retrieved_date: {type: Sequelize.DATE}
  },{underscored: true}
);

module.exports = NewsArticle;</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="_modelsreview_js"><a class="anchor" href="#_modelsreview_js"></a>10.3. models/review.js</h3>
<div class="imageblock">
<div class="content">
<img src="_images/review-model-screenshot.png" alt="Review model in user interface">
</div>
<div class="title">Figure 7. Review model in user interface</div>
</div>
<div class="listingblock">
<div class="title">models/review.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">const Sequelize = require('sequelize');
const sequelize = require('../config/db');
const Residence = require('../models/residence');

const Review = sequelize.define('review',{
    id: {type: Sequelize.UUID, allowNull: false, defaultValue: Sequelize.UUIDV4, primaryKey: true},
    name: {type: Sequelize.STRING},
    author: {type: Sequelize.STRING},
    rating_value: {type: Sequelize.DECIMAL, allowNull: false},
    description: {type: Sequelize.TEXT, allowNull: false},
    status: {type: Sequelize.STRING, allowNull: false,defaultValue: `pending`},
    author_email: {type: Sequelize.STRING, allowNull: false},
    notify: {type: Sequelize.BOOLEAN, allowNull: false,defaultValue: false},
    accepted_terms: {type: Sequelize.BOOLEAN, allowNull: false,defaultValue: false}
  },{underscored: true}
);

module.exports = Review;</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="_modelsresidence_js"><a class="anchor" href="#_modelsresidence_js"></a>10.4. models/residence.js</h3>
<div class="listingblock">
<div class="title">Create models/residence.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cd models
touch residence.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>and then we go on to create our model</p>
</div>
<div class="listingblock">
<div class="title">models/residence.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">const Sequelize = require('sequelize');
const sequelize = require('../config/db');
const NewsArticle = require('./news_article'); <i class="conum" data-value="1"></i><b>(1)</b>
const Review = require('./review');
const Residence = sequelize.define('residence', {
    id: {type: Sequelize.UUID,allowNull: false,defaultValue: Sequelize.UUIDV4,primaryKey: true},
    name: {type: Sequelize.STRING,allowNull: false},
    alternate_name: { type: Sequelize.STRING },
    description: { type: Sequelize.TEXT },
    latitude: {type: Sequelize.DECIMAL},
    longitude: {type: Sequelize.DECIMAL},
    address: {type: Sequelize.STRING,allowNull: false,unique: true},
    url: {type: Sequelize.STRING},
    status: {type: Sequelize.STRING,defaulValue: 'pending'},
    address_num: {type: Sequelize.INTEGER},
    address_street: {type: Sequelize.STRING},
    address_state: {type: Sequelize.STRING},
    address_city: {type: Sequelize.STRING},
    address_country: {type: Sequelize.STRING},
    postal_code: {type: Sequelize.STRING},
    slug: {type: Sequelize.STRING,unique: true},
    address_city_slug: {type: Sequelize.STRING,allowNull: false},
    address_state_slug: {type: Sequelize.STRING,allowNull: false}
  },{underscored: true}
);

Residence.hasMany(NewsArticle, { foreignKey: 'residence_id' }); <i class="conum" data-value="2"></i><b>(2)</b>
NewsArticle.belongsTo(Residence);
Residence.hasMany(Review, { foreignKey: 'residence_id' });
Review.belongsTo(Residence);

module.exports = Residence;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Import <code>NewsArticle</code> and <code>Review</code> models so that associations can be built with <code>Residence</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Build associations with <code>Residence</code> and other entities</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_migrations"><a class="anchor" href="#_migrations"></a>11. Migrations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>While this project is feature complete at the moment, the database may change in the future. One approach for dealing with database changes is simply to make a backup of the database and run <code>sync({force:true})</code> to rebuild the database with new changes. Doing the process this way may work but will require some patching throughout the growth of database changes.</p>
</div>
<div class="paragraph">
<p>A different approach for dealing with database changes over time is to use a migration mechanism. While <code>sequelize</code> does not come with this mechanism built in, it does have one through the usage of <code>sequelize-cli</code> node module.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Read more about migrations here :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://sequelize.org/v5/manual/migrations.html" class="bare">https://sequelize.org/v5/manual/migrations.html</a></p>
</li>
<li>
<p>and <a href="https://github.com/sequelize/cli" class="bare">https://github.com/sequelize/cli</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<h1 id="_seo" class="sect0"><a class="anchor" href="#_seo"></a>SEO</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Search engine optimization (SEO) is a beast of its own and would require its own book. In this chapter I will introduce you to some tips and good to haves in your application if it is facing the public and search engines may crawl it. If it is an internal project then perhaps this section could be totally skipped.</p>
</div>
<div class="paragraph">
<p>Elderoost&#8217;s SEO goals were to have good ranking for minimum amount of effort. In other words, I wanted to rank on the front page but anywhere within that page. To ensure best possible results available, I used the best bang for buck implementation of SEO in our project. I&#8217;ve  included a checklist at the end of the section that can help you with SEO of your project.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_minimum_seo"><a class="anchor" href="#_minimum_seo"></a>12. Minimum SEO</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For each page, I recommend the following tags to be present in the <code>&lt;head&gt;</code> section of your application layout at the minimum.</p>
</div>
<div id="layout-head" class="listingblock">
<div class="title">views/layout.hbs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">...
&lt;head&gt;
  &lt;meta charset="utf-8"&gt;
  &lt;meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"&gt;
  &lt;meta http-equiv="X-UA-Compatible" content="IE=edge"&gt;
  &lt;title&gt;{{title}}&lt;/title&gt;
  &lt;meta name="description" content="Changing the conversation when it comes to senior care." /&gt;
  {{#if canonical}}&lt;link href="{{canonical}}" rel="canonical"&gt;{{/if}}
  &lt;meta property="og:title" content="{{title}}" /&gt;
  &lt;meta property="og:url" content="https://elderoostalpha.herokuapp.com" /&gt;
  &lt;meta property="og:type" content="website" /&gt;
  &lt;meta property="og:site_name" content="Elderoost" /&gt;
  &lt;meta property="og:description" content="Changing the conversation when it comes to elderly care." /&gt;
  &lt;meta name="twitter:card" content="summary"&gt;
  &lt;meta name="twitter:site" content="@Elderoost"&gt;
  &lt;meta name="twitter:creator" content="@alexkluew"&gt;
  &lt;meta name="twitter:description" content="Changing the conversation when it comes to elderly care."&gt;
  &lt;meta name="twitter:title" content="{{title}}"&gt;
  &lt;meta itemprop="name" content="{{title}}"&gt;
  &lt;meta itemprop="description" content="Changing the conversation when it comes to senior care."&gt;
&lt;/head&gt;
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>What it comes down to is having a page title, page description, and the author for starters. I also recommend placing a canonical link the header tag. Then these three values are set in <a href="https://developer.twitter.com/en/docs/tweets/optimize-with-cards/guides/getting-started">twitter social cards</a> or <a href="https://ogp.me">open graph protocol</a>. I would look up both of the formats to get familiar about what each tag expects as its value. The basic overview was outlined above.</p>
</div>
<div class="paragraph">
<p>How to figure out what text to put in my title and description attributes? If you are not dealing with a brand new field, I would look up competitive businesses and see how they structure their search engine and social media presence. Look at both static pages and dynamic results. For example, look up length of strings and type of words that are to be placed in those strings for similar html meta tags. Search what kind of descriptions and keywords that are popular or most relevant to your project. One good thing about SEO, is that it is structured similarly on optimized websites. Look at top businesses in your project’s field and see what they have in common in their meta tags. There bound to be some similarities as similar projects would aim for similar descriptions and titles in order to provide similar results on a search engine.</p>
</div>
<div class="paragraph">
<p>If you are in a brand new field, then I would look at your most favourite brand’s websites and see how they structure their data. Then I would rely on a search engine’s guidelines. See what kind of text or keyword data places where in the search results.</p>
</div>
<div class="paragraph">
<p>I usually spend some time per project on <a href="https://adwords.google.com/aw/keywordplanner/home">Google’s Keyword Planner</a> or some similar keyword tool. I would look into what words would be relevant to my project and reference against my competition. Or in a case of a brand new field, I would test different keyword combinations for different pages and keep metrics.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_schema_org"><a class="anchor" href="#_schema_org"></a>13. Schema.org</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section we will be going over the ways that we can improve our project’s search engine physical appearance and results after we go live. Elderoost project comes with complete example of what an optimized application should aim to have. Every relevant page has the specific meta tags and descriptions set that are dynamic, and pertinent to the page’s context.</p>
</div>
<div class="paragraph">
<p>When working on SEO, my goal was to provide as much descriptive content about a specific context as possible. To get any real advantage of SEO, I needed to analyze my data. I needed to see if there was any ways to structure my data into known SEO entities. So, lets take an individual residence for example. For each section of our website we want to maximize amount of meta data that we can provide to a robot crawling our website for search engine results. In other words, you want to analyze your web pages and figure out which entities exist in which sections of the website. Then you should structure your meta data and test the implementation so that meta data is correct. I will first walk you through the way that you structure elements on a webpage using a specification below.</p>
</div>
<div class="paragraph">
<p>I analyzed my data and separated residence data by city and by province. When I did that, I noticed that this type of representation kind of looks like a breadcrumbs structure. That is exactly how I group this data in code. What you see below is that I call city an <code>ItemListElement</code> at position 2 and province as <code>ItemListElement</code> at position 1. These properties are part of the <a href="http://schema.org" class="bare">http://schema.org</a> specification which teaches us just how to describe our data. The breadcrumbs in the user interface is implemented to look like this : <code>Ontario &gt; Toronto</code>. I hope after reading this, you can appreciate why it looks like that in the UI.</p>
</div>
<div class="listingblock">
<div class="title">views/residences/show.hbs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">...
&lt;small class="padding-bottom" itemscope itemtype="http://schema.org/BreadcrumbList"&gt;
&lt;span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem"&gt;
&lt;a itemprop="item" href="/residences/by-province/{{residence.address_state_slug}}" class="main__infobox__link"&gt;
&lt;span itemprop="name"&gt;{{residence.address_state }}&lt;/span&gt;
&lt;meta itemprop="position" content="1" /&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span  itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem"&gt;
&lt;a itemprop="item" href="/residences/by-city/{{residence.address_city_slug}}" class="main__infobox__link"&gt;
&lt;span itemprop="name"&gt;{{residence.address_city}}&lt;/span&gt;
&lt;meta itemprop="position" content="2" /&gt;&lt;/a&gt;&lt;/span&gt;
&lt;/small&gt;
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the code, like you see above, I would pay attention to itemscope, itemtype, and itemprop properties attached to various html elements.</p>
</div>
<div class="paragraph">
<p>Similarly, lets take a look at how I described a single residence entry using metadata :</p>
</div>
<div style="page-break-after: always;"></div>
<div class="listingblock">
<div class="title">views/residences/show.hbs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;section class="main main-text-wrapper" itemscope itemtype="http://schema.org/Residence"&gt;
...
    &lt;meta itemprop="sameAs" content="/residences/{{residence.slug}}" /&gt;
...
      &lt;span itemprop="name"&gt;{{residence.name}}&lt;/span&gt;
...
      &lt;div itemprop="address" itemscope itemtype="http://schema.org/PostalAddress"&gt;
        &lt;i class="fa fa-map-marker fa__mod" aria-hidden="true"&gt;&lt;/i&gt;&amp;nbsp;&lt;span itemprop="streetAddress"&gt;
          {{residence.address_num}}&amp;nbsp;{{residence.address_street}}
        &lt;/span&gt;&amp;nbsp;&lt;br&gt;&lt;span itemprop="addressLocality"&gt;{{residence.address_city}}&lt;/span&gt;&amp;nbsp;&lt;span
          itemprop="addressRegion"&gt;{{residence.address_state}}&lt;/span&gt;&amp;nbsp;&lt;span
          itemprop="postalCode"&gt;{{residence.postal_code}}&lt;/span&gt;&lt;br&gt;Canada
      &lt;/div&gt;
      &lt;span itemprop="hasMap"
        content="http://maps.google.com/maps?daddr={{residence.latitude}},{{residence.longitude}}"&gt;&lt;a
          href="http://maps.google.com/maps?daddr={{residence.latitude}},{{residence.longitude}}"
          class="main__wrapper__link" rel="nofollow" target="_blank"&gt;Get directions&lt;i class="fa fa-external-link"
            aria-hidden="true"&gt;&lt;/i&gt;&lt;/a&gt;&lt;/span&gt;
      &lt;div itemprop="geo" itemscope itemtype="http://schema.org/GeoCoordinates"&gt;
        &lt;meta itemprop="latitude" content="{{residence.latitude}}" /&gt;
        &lt;meta itemprop="longitude" content="{{residence.longitude}}" /&gt;
      &lt;/div&gt;
...
	{{#each reviews as |review|}}
        &lt;article class="individual-listing-review padding-top" itemprop="review" itemscope
          itemtype="http://schema.org/Review"&gt;
          &lt;div class="review-rating"&gt;
            &lt;div itemprop="reviewRating" itemscope itemtype="http://schema.org/Rating"&gt;
              &lt;meta itemprop="worstRating" content="1"&gt;
              &lt;meta itemprop="ratingValue" content="{{rating_value}}"&gt;
              &lt;meta itemprop="bestRating" content="5"&gt;
              {{rating_value}}
            &lt;/div&gt;
          &lt;/div&gt;
          &lt;div class="review-name" itemprop="name"&gt;
            &lt;strong style="color: #111111"&gt;{{name}}&lt;/strong&gt;
            &lt;small style="color: #555555; font-style: italic;"&gt;by &lt;span itemprop="author" itemscope
                itemtype="http://schema.org/Person"&gt;&lt;span itemprop="author"&gt;{{author}}&lt;/span&gt;&lt;/span&gt;&lt;/small&gt;
          &lt;/div&gt;
          &lt;div class="review-body" itemprop="description" style="color: #4a4a4a"&gt;
            {{description}}
          &lt;/div&gt;
        &lt;/article&gt;
        {{/each}}
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is quite a bit of meta data there to describe a single residence but it is mostly the same data which is displayed on each page. How convenient?! Basically, in the meta data above, I described a senior residence name, the address, geolocation coordinates, map link to google’s map. I also described all of the possible reviews and their meta data. Each review has a rating between 1 and 5, an author, and a text description. All of this information is displayed for the user to understand and for the robots to reference about our data.</p>
</div>
<div class="paragraph">
<p>Once completed the code, you can test your metadata by a service such us one provided by google and looks like this</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/breadcrumb-residence-structure-screen-google.png" alt="Structured data testing tool from Google">
</div>
<div class="title">Figure 8. Structured data testing tool from Google</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Download <code>views/residences/show.hbs</code> template</div>
<div class="paragraph">
<p>Download complementary completed <code>views/residences/show.hbs</code> template <a href="https://bit.ly/residences-show">here</a>.</p>
</div>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_sitemap"><a class="anchor" href="#_sitemap"></a>14. Sitemap</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Do not forget to also send a sitemap representation of the application to the search engines. This way all of the SEO work will be actually found once their bots visit your submitted URLs in the sitemap format. In our procedure we will be using the sitemap module. It creates the proper sitemap for us which we will then gzip on our own. The only manual task for now is the generation of the residences URL text file as input to the sitemap.</p>
</div>
<div class="paragraph">
<p>Since this is a manual task, there is a route which you have to uncomment in the <code>residences.js</code> router handler file.</p>
</div>
<div class="listingblock">
<div class="title">routes/residences.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">...
router.get('/api/string', async (req, res, next) =&gt; {
  const residences = await Residence.findAll(); <i class="conum" data-value="1"></i><b>(1)</b>
  if (residences) {
    var str = ''; <i class="conum" data-value="2"></i><b>(2)</b>
    for (var residence of residences) {
      str = str + `https://domain.com/residences/${residence.slug}\n`;
    }
    res.send(str); <i class="conum" data-value="3"></i><b>(3)</b>
  }
});
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Find all Residence data</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This data we will convert to a single string which we will use as input to the sitemap module</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Send the data which we then copy and paste into <code>./config/sitemap-list-of-urls.txt</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When we obtain all of our link data, we can proceed to generate the sitemap. I added the command to my <code>package.json</code> like so</p>
</div>
<div class="listingblock">
<div class="title">package.json</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">...
"sitemap": "npx sitemap &lt; ./config/sitemap-list-of-urls.txt &gt; ./config/sitemap.xml", <i class="conum" data-value="1"></i><b>(1)</b>
"sitemap:gzip": "gzip -c ./config/sitemap.xml &gt; ./public/sitemap.xml.gz" <i class="conum" data-value="2"></i><b>(2)</b>
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Generate the sitemap <code>xml</code> file from the input</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Gzip the file and paste into the appropriate place in <code>public</code> folder</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>All you have to do now is figure out how to submit the sitemap url to the search engines. Each engine has their own way.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_social_share_images"><a class="anchor" href="#_social_share_images"></a>15. Social share images</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before working on this section in the project, we had decent SEO because we worked on it in the previous section. With our current code, when someone shares our link on social media only textual data will be available to describe our URL due to our current tags. So, when someone shares the link to the project on twitter, for example, then the following card will pop up based on our provided meta-data :</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="_images/card-preview-screen-v1.png" alt="Card preview screen version 1" width="300">
</div>
<div class="title">Figure 9. Card preview screen version 1</div>
</div>
<div class="paragraph">
<p>While that is better than sharing a simple link, and clearly dynamic, I could take this a bit further by adding an image to the card. This way, when someone will share our link in the future our card will look like this :</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="_images/card-preview-screen-v2.png" alt="Card preview screen version 2" width="300">
</div>
<div class="title">Figure 10. Card preview screen version 2</div>
</div>
<div class="paragraph">
<p>I wanted to do exactly as the image above shows. I wanted to add this dynamic image to my social media cards which show up whenever someone shares this project’s url. Moreover, I wanted this image to be generated on the fly by the server. To test my implementation, I used twitter&#8217;s https://cards-dev.twitter.com/validator[card preview feature].</p>
</div>
<div class="paragraph">
<p>In my express.js app I wanted to see if I could generate images of a web page. So, I went with the idea of taking web page screenshot and, then, using this screenshot as my social media card. This is done by setting the two image properties in my meta tags (just as I show you below) :</p>
</div>
<div class="paragraph">
<p>The two SEO image tags that I needed to be dynamic were : <code>og:image</code> and <code>twitter:image</code>. I adjusted the express.js project by going into my handlebars.js layout template and adding an if statement.</p>
</div>
<div class="paragraph">
<p>The if statement simply looks for the presence of <code>page_image</code> variable as one of the attributes passed on to the template. If the variable exists, then simply populate its content wherever we need it. Or, in other words :</p>
</div>
<div class="listingblock">
<div class="title">layout.hbs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">...
{{#if page_image}}
&lt;meta name="og:image" content="{{page_image}}"&gt;
&lt;meta name="twitter:card" content="summary_large_image"&gt;
&lt;meta name="twitter:image" content="{{page_image}}"&gt;
{{else}}
&lt;meta name="twitter:card" content="summary"&gt;
{{/if}}
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>From above, <code>page_image</code> variable holds just a simple string that show the location to my dynamic image generation function. The string is a combination of simply taking a residence <code>slug</code> and adding <code>/image</code> to it.</p>
</div>
<div class="paragraph">
<p>So, if I was rendering the following page</p>
</div>
<div class="literalblock">
<div class="content">
<pre>https://elderoostalpha.herokuapp.com/residences/elim-village-british-columbia-reviews</pre>
</div>
</div>
<div class="paragraph">
<p>then the image url will be</p>
</div>
<div class="literalblock">
<div class="content">
<pre>https://elderoostalpha.herokuapp.com/residences/elim-village-british-columbia-reviews/image</pre>
</div>
</div>
<div class="paragraph">
<p>This string is just passed on as data to the template.</p>
</div>
<div class="paragraph">
<p>For example, the following code..</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">...
res.render(`templateName`,{
  page_image : `https://elderoostalpha.herokuapp.com/residences/carolina-retirement-suites-ontario-reviews/image`
});
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>would translate to the if statement above evaluating to true, in the handlebars.js template, and the attached html code of the block was :</p>
</div>
<div class="listingblock">
<div class="title">layout.hbs after evaluating the content of <code>page_image</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">...
&lt;meta name="og:image" content="https://elderoostalpha.herokuapp.com/residences/carolina-retirement-suites-ontario-reviews/image"&gt;
&lt;meta name="twitter:card" content="summary_large_image"&gt;
&lt;meta name="twitter:image" content="https://elderoostalpha.herokuapp.com/residences/carolina-retirement-suites-ontario-reviews/image"&gt;
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Perfect, now our routes are dynamic just like I wanted. Now, I needed to implement the actual <code>router.get('/image')</code> function. We go to our terminal and type in the following to install puppeteer and add it to our project :</p>
</div>
<div id="puppeteer" class="listingblock">
<div class="title">Install puppeteer</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">npm install --save puppeteer</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we just code the end point that we want above. Mine looked like this :</p>
</div>
<div class="listingblock">
<div class="title">routes/residences.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">...
const express = require('express');
const puppeteer = require('puppeteer');
const router = express.Router();
...
// equivalent to :
// https://elderoostalpha.herokuapp.com/residences/:slug/image
router.get('/:slug/image', async (req, res, next) =&gt; {
  const { slug } = req.params;
  const browser = await puppeteer.launch();
  const page = await browser.newPage();
  await page.goto(`https://elderoostalpha.herokuapp.com/residences/${slug}`);
  const screenshot = await page.screenshot({
    type: 'png',
    encoding: 'binary'
  }); <i class="conum" data-value="1"></i><b>(1)</b>
  await browser.close();
  res.header('Content-Type', 'image/png'); <i class="conum" data-value="3"></i><b>(3)</b>
  res.send(screenshot); <i class="conum" data-value="2"></i><b>(2)</b>
});
...
module.exports = router;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We conveniently just save screenshot as binary output</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Then our response sends that binary data and it displays as an image</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>when we set the <code>content-type</code> of the response to <code>image/png</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Success! We added a new <code>get /residences/:slug/image</code> route that sends a dynamic screenshot image of the webpage and we mainly did this for improving our SEO value proposition.</p>
</div>
<div class="paragraph">
<p>Just as the section introduction shows, the newly created dynamic image adds a bit more value to the existing social cards. Your cards now show to the user exactly what the page looks like before they think of clicking on the social card to view it. If they click on the card and go to the actual page, then they view a familiar UI that was presented to them in the social card. This concluded our current SEO optimization. By the end of this section, my layout template had the <a href="seo.html#layout-head" class="page">following tags</a>.</p>
</div>
<div class="paragraph">
<p>And there we have it. Our residence entry has a card with a beautiful generated image on it when someone shares our project on social.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="_images/card-preview-screen-v2.png" alt="Card preview screen version 2" width="300">
</div>
<div class="title">Figure 11. Card preview screen version 2</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Now, having gone through all of the trouble of creating this, I am going to tell you not to use it like this in production. You see, there is some delay between starting up the puppeteer and returning a screenshot of a web-page. This delay is unfortunately much longer than the time it takes a social media card to load to a user. Thus, if you are running this code on your own server you may notice some cards require a refresh before they appear.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>An alternative solution would be to use this script, create all of the dynamic images, and save them somewhere where you would serve them instead of dynamically generating on the fly. A typical place to serve your assets is something like an Amazon’s S3 bucket. This way, you would change your code to serve the generated image rather than a dynamic one. You could also save these images on your server for each entry. For example, save it into your public folder under a specific name and add an attribute to your residences model to tell it the file that it needs to request from your public folder.</p>
</div>
<div class="paragraph">
<p>You can get creative and have a robot that updates all of these images and generates new ones, suppose once a day, or something like that. This depends on how often your layout changes and whether or not new images are providing much value to the social sharing.</p>
</div>
<div class="paragraph">
<p>Another solution would be to use a service that specializes in generating screenshots from urls. However, both, the AWS S3 bucket and an external API would have to be extra costs that you need to incorporate to your project.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_seo_checklist"><a class="anchor" href="#_seo_checklist"></a>16. SEO Checklist</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here is a checklist that will help you stay on track with SEO on your website or application</p>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p><i class="fa fa-square-o"></i> Switch To HTTPS</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Set Up Google Search Console</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Set Up Google Analytics</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Set Up Bing Webmaster Tools</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Create XML <code>Sitemap</code></p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Create and add a <code>robots.txt</code> file to your site</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Submit <code>sitemap.xml</code> to Google Search Console</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Submit <code>sitemap.xml</code> to Bing Webmaster Tools</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Fix Crawl Errors</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Fix Broken Links</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Fix Any Missing or Duplicate <code>Meta</code> Tags</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Keep Your URLs Short, Descriptive</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Add Schema.org Description (where relevant)</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Use a Keyword Research Tool</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Optimize the Readability of Your Content</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Add Your Keyword to Your <code>Title</code> Tag</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Add Your Keyword to Your <code>Meta</code> Description</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Add Your Keyword to Your <code>H1</code> Tag</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Include Your Keyword in the <code>Body</code> of the Page</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Find long-tail keyword variations and use in the <code>Body</code> of the Page</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Label Your Images with Descriptive <code>ALT</code> Tags</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Use Internal Links</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Link to Authoritative Sites</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Reverse-Engineer Your Competitors’ Links and <code>Meta</code> Tags, Keywords</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Make Sure Your Site Doesn’t Have Duplicate Content</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Claim Your Brand Name on as Many Social Networks as Possible</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Make Your Site Mobile Friendly</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Speed Up Your Site</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Using WordPress Software? Install Yoast SEO Plugin</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Add Social Sharing Images</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Add Tags and Categories</p>
</li>
</ul>
</div>
</div>
</div>
<h1 id="_maps" class="sect0"><a class="anchor" href="#_maps"></a>Maps</h1>
<div class="openblock partintro">
<div class="content">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I will introduce you to GeoJSON format for passing data, Leaflet library for making maps, and Fuse for searching.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://leafletjs.com/">Leaflet</a> is perhaps not only a map library but the main component that is used everywhere throughout the Elderoost project. After all, Elderoost is built to be heavily visual, accessible, and responsive. Leaflet API is nicely documented and comes with tons of additional plugins. Two of these plugins, one for clustering points together and the other for powerful searching, will be introduced in this chapter. I use this library on the main screen and on each individual residence screen.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_leaflet_js"><a class="anchor" href="#_leaflet_js"></a>17. Leaflet.js</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://leafletjs.com/">Leaflet</a>  was selected as the default map library for my project because it just works, is open-source, and has a plethora of useful plugins. Creation of a map is simple, I just needed to imbed the following code in my handebarsjs page to request the library and its css code :</p>
</div>
<div class="listingblock">
<div class="title">views/index.hbs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">...
&lt;link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin="" /&gt; <i class="conum" data-value="1"></i><b>(1)</b>
&lt;script src="/javascripts/leaflet/leaflet.min.js"&gt;&lt;/script&gt; <i class="conum" data-value="2"></i><b>(2)</b>
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Leaflet library has some default styling that needs to be imported for everything to work</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The actual library is included with the source code for this book</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then I just needed to instantiate the map somewhere in the code; like this for example :</p>
</div>
<div class="listingblock">
<div class="title">views/index.hbs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">...
L.map("map", {
  scrollWheelZoom: false
}).setView([45.416191, -75.691727], 5)
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the following section I will go through the construction of the map as it is shown above. The actual map is instantiated using GeoJSON data and grouped into clusters. In this section I simply wanted to show how easy  it is to work with Leaflet library.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>See <a href="introduction.html#index-hbs" class="page">index.hbs</a> explanation</p>
</div>
</td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="geoJSON"><a class="anchor" href="#geoJSON"></a>18. GeoJSON</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://geojson.org/">GeoJSON</a> is a specification format that tells us of a way to represent geographic data in JSON object form. You can see the format below and it stores data in two ways: (i) single features and (ii) feature collections. A feature is a collection of data that describes a geographic object like a point or a shape. In this project, we will be using this format to work with our data and describe our map. By using a format, I can ensure some data integrity for the future as well because formats rarely change. This way we can structure our data however we want on the server and send it to the client UI to simply display.</p>
</div>
<div class="paragraph">
<p>In our project, there are several requirements when it comes to data attributes of a residence that I assume each one of the data points has : (i) name field, (ii) address field, (iii) latitude field, and (iv) longitude field. If you were looking just to experiment, I recommend having at least a name, latitude, and longitude attributes on a data model. The name field would be used as a separator.</p>
</div>
<div class="paragraph">
<p>For a single entry, our <code>Feature</code> object should look like so :</p>
</div>
<div class="listingblock">
<div class="title">GeoJSON format for a Feature object</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  type: "Feature",
  properties: {
    name: "Canterbury Place Retirement Residence",
    address: "1 Canterbury Place, North York, Ontario M2N 0G7",
    slug: "canterbury-place-retirement-residence-ontario-reviews"
  },
  geometry: {
    type: "Point",
    coordinates: [
      -79.414597,
      43.771693
    ]
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>From the code above you can see that I am expressing a single residence object by its specific properties such as name, address, and id slug; and by its geometry which is a simple point located at a specific longitude and latitude.</p>
</div>
<div class="paragraph">
<p>For a collection, more than 1, you simply wrap a bunch of these Feature objects in an array as a features property of the <code>FeatureCollection</code> object.</p>
</div>
<div class="listingblock">
<div class="title">GeoJSON format for a FeatureCollection object</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  type: "FeatureCollection",
  features: [
    {
         type: "Feature",
         properties: {
           name: "Canterbury Place Retirement Residence",
           address: "1 Canterbury Place, North York, Ontario M2N 0G7",
           slug: "canterbury-place-retirement-residence-ontario-reviews"
       },
      	  geometry: {
           type: "Point",
           coordinates: [
            -79.414597,
            43.771693
           ]
       }
    }
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The way that this data is then used in the following.  Leaflet library has a constructor, a way to initiate the object, using GeoJSON data. This data must be in either <code>Feature</code> or <code>FeatureCollection</code> type.</p>
</div>
<div class="paragraph">
<p>So, during map construction, I make a call to my api that sends back the <code>FeatureCollection</code> object. Then, I simply feed the ready data in Leaflet’s constructor and the map with data points appears.</p>
</div>
<div class="paragraph">
<p>This is how the collection gets created on the server :</p>
</div>
<div id="geoJSON-data" class="listingblock">
<div class="title">routes/residences.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">...
router.get('/api/', async (req, res, next) =&gt; {
  try {
    const residences = await Residence.findAll();
    if (residences) {
      const mapped = residences.map(residence =&gt; {
        return {
          type: 'Feature',
          properties: {
            name: residence.name,
            address: residence.address,
            slug: residence.slug
          },
          geometry: {
            type: 'Point',
            coordinates: [
              Number(residence.longitude),
              Number(residence.latitude)
            ]
          }
        };
      });
      const result = {
        type: 'FeatureCollection',
        features: mapped
      };
      res.send(JSON.stringify(result));
    }
  } catch (_error) {
    console.error(`error in /api/ : ${_error}`);
    res.sendStatus(200);
  }
});
...</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>See <a href="introduction.html#index-hbs" class="page">index.hbs</a> explanation for GeoJSON data injestion</p>
</div>
</td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_markers_vs_clusters_plugin"><a class="anchor" href="#_markers_vs_clusters_plugin"></a>19. Markers vs. Clusters plugin</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="_images/marker-v-cluster-screen.png" alt="Marker vs. Cluster view">
</div>
<div class="title">Figure 12. Marker vs. cluster screen view</div>
</div>
<div class="paragraph">
<p>This section is mainly optional as it requires adding a plugin to your project, but I did implement it in my projet Elderoost. When I began working on the project, I did not have many data points. Thus, when I was working with the map I did not notice any performance issues nor did I have any issues with locating individual residences. However, as my data grew, so did my data points. The amount of data made my project look like this without any clustering on it :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/unclustered-screen.png" alt="Leaflet.js map with unclustered data">
</div>
<div class="title">Figure 13. Leaflet.js map with unclustered data</div>
</div>
<div class="paragraph">
<p>With so many data points crowding the map, it became much harder to browse the map and get any value out of it. In addition, it took much more time for the map and all of the data points to be generated. Plus, while it was generating the map, the performance of the entire app became sluggish.</p>
</div>
<div class="paragraph">
<p>I went to the <a href="https://leafletjs.com/plugins.html">plugin section</a> of leaflet’s library and came across the clustering markers solution, <code>leaflet.markercluster.js</code>. I quickly downloaded the library and set it up in the code. As soon as I refreshed the page, everything became clustered and the page performance felt much snappier.</p>
</div>
<div class="paragraph">
<p>To add clustering to our map is actually very simple. We first import the library plugin in the html:</p>
</div>
<div class="listingblock">
<div class="title">views/index.hbs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">...
&lt;script src="/javascripts/leaflet-markercluster/leaflet.markercluster.js"&gt;&lt;/script&gt;
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>and then we load the required css by the library :</p>
</div>
<div class="listingblock">
<div class="title">views/index.hbs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">...
&lt;link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"/&gt;
&lt;link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"/&gt;
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>and finally put everything together in the handlebars template like so :</p>
</div>
<div class="listingblock">
<div class="title">views/index.hbs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">...
  var newLayer = L.markerClusterGroup({ <i class="conum" data-value="1"></i><b>(1)</b>
      chunkedLoading: true,
      showCoverageOnHover: false
  });
  newLayer.addLayer(geoJSONLayer); <i class="conum" data-value="2"></i><b>(2)</b>
  map.addLayer(newLayer); <i class="conum" data-value="3"></i><b>(3)</b>
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Instantiate the cluster group object</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Add geoJSON data that will be clustered</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add everything to the map</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There we have it. Now the marker points, that we previously had individually displayed, will be automagically grouped together as needed into clusters. By clicking on the cluster the user will then zoom in on that cluster area and individual markers from that cluster will then appear.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>See <a href="introduction.html#index-hbs" class="page">index.hbs</a> explanation</p>
</div>
</td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_search_plugin"><a class="anchor" href="#_search_plugin"></a>20. Search Plugin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://github.com/naomap/leaflet-fusesearch">leaflet-fusesearch</a> plugin is very easy to integrate and it works extremely well out of the box with minimum configurations needed. For these reasons alone, I introduced this library and a new feature into my map. This is a second search feature in my project that allows a user to search in my UI. This search is specific to the leaflet library and depends on the provided data to be in geoJSON format. Please note that this library depends on the <a href="https://github.com/krisk/Fuse">Fuse.js</a> fuzzy search library for its searching functionality. Therefore, we need to load fuse.js search prior to loading this search library.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/map-search-screen.png" alt="Map search plugin">
</div>
<div class="title">Figure 14. Leaflet.js search plugin</div>
</div>
<div class="paragraph">
<p>The way that the search works is that it takes in geoJSON data during its instantiation and looks at each individual feature’s properties. In our case, each feature has a name, address, and slug properties. I have indexed each residence on its name and address properties. The slug property is useful for me only and it simply is used as an identifier for each residence during creation of a link. Thus, there is no need to search by the slug property.</p>
</div>
<div class="paragraph">
<p>When a user begins typing, the results field shows data that matches by either name or address <a href="introduction.html#index-hbs-map" class="page">properties</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>See <a href="introduction.html#index-hbs" class="page">index.hbs</a> explanation</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<h1 id="_pagination" class="sect0"><a class="anchor" href="#_pagination"></a>Pagination</h1>
<div class="openblock partintro">
<div class="content">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In this chapter I walk you through a small project that you can use to add pagination to any route that you like in your projects.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/pagination-screen.png" alt="Residences pagination feature">
</div>
<div class="title">Figure 15. Residences pagination feature</div>
</div>
<div class="paragraph">
<p>The goal of this chapter is to show how one can go from a table UI showing lots of data points to a paginated table UI. To do this, I needed to check if my database supports <code>offset</code> and <code>limit</code> properties. What followed, was finding that , both, PostgresSQL and Sequelize support these parameters. I needed to create the code.</p>
</div>
<div class="paragraph">
<p>I did this by adding a new query in the url <code>?page=1</code> for the <code>/residences</code> page which indicates which page the user is browsing, starting with page 0. The default behaviour of this simple pagination feature is to browse the residences list one page at a time. If one were to try this feature, I think one would notice that either search or view map features offer better performance and quicker find-ability.</p>
</div>
<div class="paragraph">
<p>I made a deliberate decision when I opted to add <code>?page=1</code> to <code>/residences</code>. Thus, the proper url was now <code>/residences?page=1</code> and not just <code>/residences</code>.</p>
</div>
<div class="paragraph">
<p>This decision allows me to make the following code using the query.page property of the req object of the /residences route handler. In other words, here is what the code looks like :</p>
</div>
<div class="listingblock">
<div class="title">./routes/residences.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">...
router.get('/', async (req, res, next) =&gt; {
  try {
    const currentPage =
      req.query.page &amp;&amp; Number(req.query.page) &gt; 0 ? Number(req.query.page) : 0;
    const offset = currentPage * 25;
    const prevPage = currentPage - 1 &gt;= 0 ? currentPage - 1 : 0;
    const nextPage = currentPage + 1;
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code above is setting up the values of previous page, current page, and next page variable. In addition, I wanted my pages to contain 25 elements. So, my offset was calculate simply by the position of the <code>?page=1</code> parameter being multiplied by 25. In the code, I also check for the boundary of zero and if the value is below zero, I simply set the whatever value to zero. In my current code, we cannot have negative pages.</p>
</div>
<div class="paragraph">
<p>These parameters are then just passed to the page template. In the page template, they simply set the appropriate value for the previous and next pages. Please notice that in the following code I also calculate the number of total pages with the anticipation of future features that links to the last page.</p>
</div>
<div class="listingblock">
<div class="title">./routes/residences.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">...
const residences = await Residence.findAndCountAll({
  offset: offset,
  limit: 25
});
const { count, rows } = residences;
const totalPages = count / 25;
const page = {
  prevPage,
  currentPage,
  nextPage,
  totalPages
};
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>What comes next is simply passing all of this data down to the template like so</p>
</div>
<div class="listingblock">
<div class="title">./routes/residences.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">...
res.render('residences/index', {
  title: `Residences - Elderoost`,
  residences: rows,
  page: page
});
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then I needed to glue all of the pieces together in the handlebarsjs template in the following way</p>
</div>
<div class="listingblock">
<div class="title">./views/residences/index.hbs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">...
{{#if page}}
&lt;a href="/residences?page={{page.prevPage}}" class="main__wrapper__link"&gt;Previous&lt;/a&gt;
&lt;a href="/residences?page={{page.nextPage}}" class="main__wrapper__link"&gt;Next&lt;/a&gt;
{{/if}}
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>and when I refreshed my <code>/residences?page=1</code> route I got my pagination function at the bottom of the screen just like in the chapter’s picture.</p>
</div>
</div>
</div>
<h1 id="_authentication_and_authorization" class="sect0"><a class="anchor" href="#_authentication_and_authorization"></a>Authentication and Authorization</h1>
<div class="openblock partintro">
<div class="content">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Secure user workflows are required in modern projects. In this chapter we are going to explore user logins, registration, security, and forgot password user flow designs, and implementation logic.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Before working on the actual code implementation of this section I had some requirements that I wanted to satisfy.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="_images/user-usecases.png" alt="user usecases">
</div>
<div class="title">Figure 16. User use cases design</div>
</div>
<div class="paragraph">
<p>First, I wanted at least 4 screens : login, create an account, forgot password, and profile page screens. Second, I wanted the passwords to be stored securely and not in plain text. Third, and finally, I wanted the reset my password user flow to send emails.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_secure_user_sign_in"><a class="anchor" href="#_secure_user_sign_in"></a>21. Secure user sign-in</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I consulted OWASP for the following four wiki pages that gave me the necessary background refresher that I needed on passwords. The sources were :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html" class="bare">https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html</a></p>
</li>
<li>
<p><a href="https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html" class="bare">https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html</a></p>
</li>
<li>
<p><a href="https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html" class="bare">https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html</a></p>
</li>
<li>
<p><a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html" class="bare">https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html</a></p>
</li>
<li>
<p>and <a href="https://owasp.org/www-project-top-ten/" class="bare">https://owasp.org/www-project-top-ten/</a></p>
</li>
</ol>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="_images/login-activity-screen.png" alt="Login user flow">
</div>
<div class="title">Figure 17. Login user flow design</div>
</div>
<div class="paragraph">
<p>To get the login page, I wrote a simple router that passes on the page title and the csrf token to the template.</p>
</div>
<div class="listingblock">
<div class="title">routes/users.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">router.get('/signin', csrfProtection, (req, res, next) =&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
    res.render('users/sign-in', { <i class="conum" data-value="2"></i><b>(2)</b>
      title: `Login - Elderoost`, <i class="conum" data-value="3"></i><b>(3)</b>
      csrfToken: req.csrfToken() <i class="conum" data-value="4"></i><b>(4)</b>
  });
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Add csrf protection that adds <code>csrfToken()</code> function to <code>req</code> object</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Render <code>views/users/sign-in.hbs</code> template</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set title for the template</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Pass csrf token to be used in signin form</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next, I needed to create the template so that a user could sign in. I know that in the template I wanted a user login using an email address and a password to sign in. Additionally, I wanted the UI to have a link to create a user account page and to the reset password page. I went ahead and created the form and the UI in the following block :</p>
</div>
<div class="listingblock">
<div class="title">views/users/sign-in.hbs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;form action="/users/signin" method="POST"&gt; <i class="conum" data-value="1"></i><b>(1)</b>
  &lt;input type="hidden" name="_csrf" value="{{csrfToken}}"&gt; <i class="conum" data-value="2"></i><b>(2)</b>
  &lt;div class="field"&gt;
    &lt;label class="label" for="email"&gt;Email&lt;/label&gt;
    &lt;div class="input-wrapper"&gt;
      &lt;input id="email" name="email" type="email" class="input" required spellcheck="false" autocomplete="off"&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;div class="field"&gt;
    &lt;label class="label" for="password"&gt;Password&lt;/label&gt;
    &lt;div class="input-wrapper"&gt;
      &lt;input id="password" name="password" type="password" class="input" required spellcheck="false"
        autocomplete="off"&gt;
      &lt;p class="help"&gt;Forgot your password? &lt;a href="/users/forgot" class="main__wrapper__link"&gt;Reset password&lt;/a&gt;&lt;/p&gt; <i class="conum" data-value="3"></i><b>(3)</b>
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;button class="button is-primary full-width" type="submit"&gt;Login &lt;i class="fa fa-sign-in-alt"
      aria-hidden="true"&gt;&lt;/i&gt;&lt;/button&gt;
&lt;/form&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Our form handler url</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This is the csrf token that we passed from the code block previously</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Link to our forgot password page</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Great! Our user can now visit our <code>/users/signin</code> route and see a functional login form that is csrf protected.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/login-screen.png" alt="Login screen">
</div>
<div class="title">Figure 18. Login Screen</div>
</div>
<div class="paragraph">
<p>So, naturally, we need to now move on to the code that is responsible for processing this form. The following code works on the form and signs in a user into our application if the email and password match. Back I went into our <code>./routes/users.js</code> router and added a new route.</p>
</div>
<div class="paragraph">
<p>I made sure that this next router is waiting for a <code>POST</code> on my <code>/users/signin</code> route. Before working on the code we need to install a few dependent libraries :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>bcrypt for comparing passwords in the database to the passed string</p>
</li>
<li>
<p>and secure client-session library that will allow us to maintain a user sessions.</p>
</li>
</ol>
</div>
<div id="install-bcrypt" class="listingblock">
<div class="title">Lets open up the terminal and install them</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">npm install --save bcrypt
npm install --save client-sessions</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that our two dependencies are installed, lets work on the code to make it look like this :</p>
</div>
<div class="listingblock">
<div class="title">routes/users.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">...
const bcrypt = require('bcrypt');
const saltRounds = 12;
...
router.post('/signin', csrfProtection, async (req, res, next) =&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
  const { email, password } = req.body;
  if (email &amp;&amp; password) { <i class="conum" data-value="2"></i><b>(2)</b>
    const user = await User.findOne({ where: { email: `${email}` } });
    if (user) { <i class="conum" data-value="3"></i><b>(3)</b>
      const compared = await bcrypt.compare(password, user.password);
      if (compared) { <i class="conum" data-value="4"></i><b>(4)</b>
        const _user = { <i class="conum" data-value="5"></i><b>(5)</b>
          username: user.username,
          email: user.email,
          is_admin: user.is_admin
        };
        req.session.user = _user; <i class="conum" data-value="6"></i><b>(6)</b>
        res.redirect('/users/profile');
      } else {
        res.redirect('/users/signin');
      }
    } else {
      res.redirect('/users/signin');
    }
  } else {
    res.redirect('/users/signin');
  }
});
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Run csrf protection to ensure our tokens match</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Check if the user entered an email and a password</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Check if a user with such an email exists in our database</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Check if password equals what we have in our database using bcrypt</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Create a <code>User</code> object using user&#8217;s data</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Set the session data so the user can be remembered as logged in</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>First thing, like all of the other forms in the app, is the csrf protection that will be checked via the <code>csrfProtection</code> function. If it passes, then my code will be executed. In my code, I am expecting the <code>email</code> and <code>password</code> variables to be passed in the request. If either of these items is missing, then I send the user back to the main login page.</p>
</div>
<div class="paragraph">
<p>From there, I asked sequelize to run a query in our postgresql database and find a user by their email. If the user exists, then great and we are ready to move on to the password comparison. Otherwise, redirect the user back to the main login page. If the user exists, we call <code>bcrypt.compare(password,hash)</code> function which returns a true or a false. If the password matches the email, then we create a new user object, <code>_user</code>, with their <code>username</code>, <code>email</code>, and <code>is_admin</code> variables set. I then attach this object to our session object, <code>req.session.user</code>, so that when the user returns after leaving, we could recognize them again in the future. After confirming the password and setting a new user session, I redirect the user to their profile page.</p>
</div>
<div style="page-break-after: always;"></div>
<div class="sect2">
<h3 id="_secure_user_sessions"><a class="anchor" href="#_secure_user_sessions"></a>21.1. Secure user sessions</h3>
<div class="paragraph">
<p>The session cookie object is added on startup of the project using the <code>client-sessions</code> library.</p>
</div>
<div class="listingblock">
<div class="title">app.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">...
const sessions = require('client-sessions'); <i class="conum" data-value="1"></i><b>(1)</b>
const SECRET = process.env.TOP_SECRET; <i class="conum" data-value="2"></i><b>(2)</b>
...
app.use(
  sessions({
    cookieName: 'session', <i class="conum" data-value="3"></i><b>(3)</b>
    secret: SECRET, <i class="conum" data-value="4"></i><b>(4)</b>
    duration: 24 * 60 * 60 * 1000,
    activeDuration: 1000 * 60 * 5
  })
);
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Import the library</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set a secret token to encrypt our session cookie data with</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set the cookie&#8217;s name; this string is also how you access this cookie in <code>req</code> object. For example, if cookieName is <code>myName</code> then the session cookie data would be accessed via <code>req.myName</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Encrypt the cookie using the secret token.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The code above allows you to access <code>req.session</code> object in your router handler. This means that whatever text you put in <code>cookieName: 'objectName'</code> is what will be available as <code>req.objectName</code> so pay attention to this area during setup.</p>
</div>
<div class="paragraph">
<p>The following function is responsible for checking if a user is present on every call. This is done by using the client-sessions library check during the request and allows me to quickly set <code>req.user</code> object during this function.</p>
</div>
<div class="listingblock">
<div class="title">app.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">...
const sessionRequestHandler = async (req, res, next) =&gt; {
  if (req.session &amp;&amp; req.session.user &amp;&amp; req.session.user.email) {
    const user = await User.findOne({
      where: { email: req.session.user.email },
    });
    if (user) {
      const _user = {
        username: user.username,
        email: user.email,
        is_admin: user.is_admin,
      };
      req.user = _user;
      req.session.user = _user;
      res.locals.user = req.session.user;
    }
  }
  next();
};
app.use(sessionRequestHandler);
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code is inserted above before any other router handlers. The <code>sessionRequestHandler</code> checks on every request if a client is a known user or a guest visitor. If they are a returning user, then we adjust the session data and set the user variable to be accessible by our templates by setting the <code>req.locals.user</code> variable.</p>
</div>
<div class="paragraph">
<p>This is the basics of authentication : finding the correct user based on some criteria, such as password and email in our case; then setting the session data for each request; and followed by checking the session data on returning requests to see if a user is who they say they are. This way you can implement authorization later on in the chapter. Authorization basically ensures that the user has access or permissions to do whatever they are requesting to do. In our app, this is done by an admin flag to differentiate between two types of users.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="_images/sessionRequestHandler.png" alt="sessionRequestHandler">
</div>
<div class="title">Figure 19. sessionRequestHandler function as outlined in code previously. hasSession? is simply a simplification for the following expression evaluation : <code>req.session &amp;&amp; req.session.user &amp;&amp; req.session.user.email</code></div>
</div>
<div class="paragraph">
<p>Our app has two users : (a) registered user and (b) admin user. A registered user obtains permissions such as view more content on the screens of residences : add an article sections, a review section, and a comments section. Whereas, an admin user gains powerful dashboard that controls the contents of the app.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_secure_create_user_account"><a class="anchor" href="#_secure_create_user_account"></a>22. Secure create user account</h2>
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="_images/create-accnt-activity-screen.png" alt="Create account user flow">
</div>
<div class="title">Figure 20. Create account user flow design</div>
</div>
<div class="paragraph">
<p>Similar coding process as the section on login user flow. First create a <code>get</code> route that would obtain the required handlebarsjs template and then pass into it the title and csrf token to the page. I passed the csrf token through because the page had a submission form on it.</p>
</div>
<div class="listingblock">
<div class="title">routes/users.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">...
router.get('/signup', csrfProtection, (req, res, next) =&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
    res.render('users/sign-up', { <i class="conum" data-value="2"></i><b>(2)</b>
        title: `Create an account on Elderoost`, <i class="conum" data-value="3"></i><b>(3)</b>
        csrfToken: req.csrfToken() <i class="conum" data-value="4"></i><b>(4)</b>
    });
});
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Add csrf protection that adds <code>csrfToken()</code> function to <code>req</code> object</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Render <code>views/users/sign-up.hbs</code> template</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set title for the template</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Pass csrf token to be used in sign-up form</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next, I followed through with creating the sign-up template in handle bars. I wanted to user to sign up using an email address, username, and a password. The username will be able to be changed but email will not be unless the user emails us, the admins and we do that manually. Please notice that at the bottom of the form below I added a line about <em>privacy policy</em> and <em>terms of service</em>. You need something like this in your own app if you are serving customers from the EU or ones that comply with the GDPR.</p>
</div>
<div class="listingblock">
<div class="title">views/users/sign-up.hbs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;section class="main main-text-wrapper"&gt;
  &lt;div class="main__wrapper-purple padding-left padding-right"&gt;
    &lt;h1 class="main__wrapper-purple__text"&gt;Create your free account
    &lt;/h1&gt;
  &lt;/div&gt;
  &lt;div class="main__wrapper main__negative-top-margin"&gt;
    &lt;div class="padding-left padding-right padding-top padding-bottom"&gt;
      &lt;form action="/users/signup" method="POST"&gt; <i class="conum" data-value="1"></i><b>(1)</b>
        &lt;input type="hidden" name="_csrf" value="{{csrfToken}}"&gt; <i class="conum" data-value="2"></i><b>(2)</b>
        &lt;div class="field"&gt;
          &lt;label class="label" for="username"&gt;Username&lt;/label&gt;
          &lt;div class="input-wrapper"&gt;
            &lt;input id="username" name="username" type="text" class="input" required spellcheck="false" autocomplete="off"&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class="field"&gt;
          &lt;label class="label" for="email"&gt;Email&lt;/label&gt;
          &lt;div class="input-wrapper"&gt;
            &lt;input id="email" name="email" type="email" class="input" required spellcheck="false" autocomplete="off"&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class="field"&gt;
          &lt;label class="label" for="password"&gt;Password&lt;/label&gt;
          &lt;div class="input-wrapper"&gt;
            &lt;input id="password" name="password" type="password" class="input" required spellcheck="false"
              autocomplete="off"&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;button class="button is-primary full-width" type="submit"&gt;Create account &lt;i class="fa fa-sign-in-alt"
            aria-hidden="true"&gt;&lt;/i&gt;&lt;/button&gt;
      &lt;/form&gt;
      &lt;p&gt;By registering, you agree to the &lt;a href="/privacy?ref=signup" class="main__wrapper__link"&gt;privacy policy&lt;/a&gt; <i class="conum" data-value="3"></i><b>(3)</b>
        and &lt;a href="/tos?ref=signup" class="main__wrapper__link"&gt;terms of service&lt;/a&gt;.&lt;/p&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/section&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Route handler that will process this form</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Csrf protection token set as hidden field attribute</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Link to privacy policy and terms of service (optional but recommended for GDPR compliance)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After writing the code, we can take a look at the produced UI :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/create-account-screen.png" alt="Create account screen">
</div>
<div class="title">Figure 21. Create account screen that requires a user to enter a username, email, and password values</div>
</div>
<div class="paragraph">
<p>Now, that we can display the create account screen and enter data, we need to work on the route handler that will process this form and create an account if successful. Basically, all of our users are required to have an email address. Thus, we will assume that the user that is creating an account does not have an entry for their email address in our database. Based on model of our data, located in <code>models/user.js</code> our users also must have a unique username. If the email and username are not in our database then our creation of a user will not fail. Otherwise, the form will throw an error and redirect back to sign-up screen.</p>
</div>
<div class="paragraph">
<p>The following step is processing the data from the create account form submission. We simply  create a new <code>post</code> route handler for the <code>POST</code> requests to <code>/users/signup</code> api point. Then we process the business logic as outlined before, and after a successful sign up we set the user session cookie and redirect them to their profile page.</p>
</div>
<div class="listingblock">
<div class="title">routes/users.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">...
router.post('/signup', csrfProtection, async (req, res, next) =&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
  const { username, email, password } = req.body;
  if (username &amp;&amp; email &amp;&amp; password) { <i class="conum" data-value="2"></i><b>(2)</b>
    const user = await User.findOne({ where: { email: `${email}` } });
    if (!user) { <i class="conum" data-value="3"></i><b>(3)</b>
      const hash = await bcrypt.hash(password, saltRounds); <i class="conum" data-value="4"></i><b>(4)</b>
      const _user = await User.create({ <i class="conum" data-value="5"></i><b>(5)</b>
        username: username,
        email: email,
        password: hash
      });
      if (_user) {
        const __user = {
          username: _user.username,
          email: _user.email,
          is_admin: _user.is_admin
        };
        req.session.user = __user; <i class="conum" data-value="6"></i><b>(6)</b>
        res.redirect('/users/profile');
      } else {
        res.redirect('/users/signup');
      }
    } else {
      res.redirect('/users/signup');
    }
  } else {
    res.redirect('/users/signup');
  }
});
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Prior to working on the logic run csrf proctection</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Ensure user entered values for username, email, and password</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Ensure we don&#8217;t have a user with such email</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Create a password hash using <code>bcrypt</code></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Create new user</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Set <code>session</code> object to our user object</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Please refer to <a href="#install-bcrypt">sign in</a> code for bcrypt and sessions explanation.
</td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_secure_user_password_resets"><a class="anchor" href="#_secure_user_password_resets"></a>23. Secure user password resets</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I built my token reset mechanism around a central requirement of my application where a user cannot change their email by default. This ensures that the user’s email is the source of truth for a user in my app. So, creating a password reset tool also depends on this requirement. I will be sending a reset token to the user via their registered email address. The user will have to enter this token on a screen in order to gain access to the password reset screen. In total, this action for resetting a password will require three screens :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>screen for the user to enter an email for gain a reset token by email</p>
</li>
<li>
<p>screen with instructions what to do after step 1. In our case simply we will state that the user will need to check their email for a reset instructions. In the email we will have a link to our app with the reset token set for the user.</p>
</li>
<li>
<p>screen for the user to set a new password. The only way to access this screen will be by using the newly generated reset token that the user received via our automatic email.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>So, lets begin working on the first screen by creating a new route that will be the home for this screen. In our case, the password reset screen lives at the <code>/users/forgot</code> route :</p>
</div>
<div class="listingblock">
<div class="title">routes/users.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">router.get('/forgot', csrfProtection, (req, res, next) =&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
  res.render('users/forgot', { <i class="conum" data-value="2"></i><b>(2)</b>
    title: `Reset password - Elderoost`, <i class="conum" data-value="3"></i><b>(3)</b>
    csrfToken: req.csrfToken() <i class="conum" data-value="4"></i><b>(4)</b>
  });
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Add csrf protection that adds <code>csrfToken()</code> function to <code>req</code> object</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Render <code>views/users/forgot.hbs</code> template</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set title for the template</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Pass csrf token to be used in forgot form</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>and the password reset form for the first objective looks like so :</p>
</div>
<div class="listingblock">
<div class="title">views/users/forgot.hbs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;section class="main main-text-wrapper"&gt;
  &lt;div class="main__wrapper-purple padding-left padding-right"&gt;
    &lt;h1 class="main__wrapper-purple__text"&gt;Reset password&lt;/h1&gt;
  &lt;/div&gt;
  &lt;div class="main__wrapper main__negative-top-margin"&gt;
    &lt;div class="padding-left padding-right padding-top padding-bottom"&gt;
      &lt;form action="/users/forgot" method="POST"&gt; <i class="conum" data-value="1"></i><b>(1)</b>
        &lt;input type="hidden" name="_csrf" value="{{csrfToken}}"&gt; <i class="conum" data-value="2"></i><b>(2)</b>
        &lt;div class="field"&gt;
          &lt;label class="label" for="email"&gt;Email&lt;/label&gt;
          &lt;div class="input-wrapper"&gt;
            &lt;input id="email" name="email" type="email" class="input" required spellcheck="false" autocomplete="off"&gt;
            &lt;p class="help"&gt;If the email exists, we will reset your password and send an email with instructions for
              creating a new password.&lt;/p&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;button class="button is-primary full-width" type="submit"&gt;Reset password&lt;/button&gt;
      &lt;/form&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/section&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Route that will handle this form submission</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Csrf token that we passed to the template</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/reset-password-screen.png" alt="Password reset screen">
</div>
<div class="title">Figure 22. Password reset screen</div>
</div>
<div class="paragraph">
<p>The next step would be working on the logic for processing the form. Please notice that as a simple security precaution I do not want to notify the user that is doing reset if the reset was successful. I do not want bad actors to know if a specific email exists in my database or not. They could potentially do that if you send a message like <code>"This email does not exist"</code> for a failed password reset and no message for a successful reset. I suggest that a better message is like one I wrote in my form, <code>"If the email exists, we will reset your password and send an email with instructions for creating a new password."</code></p>
</div>
<div class="paragraph">
<p>We will be using SendGrid service to send our emails in this section. I want the email to simply contain plain text message of the reset password token in the body of the email. Using SendGrid is very simple plus they allow up to 100 free emails to be sent daily. As a starter project or a small project, I think this will be enough for our transactional needs. Please register for an account and acquire their API key.</p>
</div>
<div class="paragraph">
<p>To do that, go login to your account :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/sendgrid-login-screen.png" alt="SendGrid login screen">
</div>
<div class="title">Figure 23. SendGrid login screen</div>
</div>
<div class="paragraph">
<p>Then, find the settings menu and go to the API key section right after logging in. In the API keys section, you will be able to create a new API key. When you will be prompted for access, I would go ahead and give it full access for now. Go ahead, and do that like so :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/sendgrid-api-screen.png" alt="SendGrid API Key Screen">
</div>
<div class="title">Figure 24. SendGrid API key screen</div>
</div>
<div class="paragraph">
<p>Please take a moment and get acquainted with SendGrid and its offerings. Now that you have your SendGrid API key, we can go back to implementing our password reset logic.  Let’s set up the SendGrid library so that we can send an email later. First we install the library :</p>
</div>
<div class="listingblock">
<div class="title">Install SendGrid library</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">npm install --save @sendgrid/mail</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, we go ahead and import the library in the same <code>./routes/users.js</code> router handler that we have been working on for this Chapter. For the sake of simplicity, I included the API key as a variable in the code. Please <strong>do not</strong> do that in production and rather set it to an environmental variable like the commented out code suggests.</p>
</div>
<div class="listingblock">
<div class="title">routes/users.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">...
const sgMail = require('@sendgrid/mail');
const sgAPI = `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`;
sgMail.setApiKey(sgAPI);
// sgMail.setApiKey(process.env.SENDGRID_API_KEY); <i class="conum" data-value="1"></i><b>(1)</b>
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In production environment, please use environmental variables and not inline the key in code</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we are ready to send out emails and, thus, let’s go back to working on processing the reset password form.</p>
</div>
<div class="paragraph">
<p>On the post request we are expecting only one input which we require and that is an email. If the email does not exist, we do nothing and send the user to the next page. If the email exists, I did not want to simply reset the users password. I wanted to create a token that the user would receive via email. The user would need to enter this token in another screen where they will be able to set a new password. The only way to get this token is via our automatic email that is sent by SendGrid. I format our simple email and send it out on successful reset. The token gets generated by a third party library called generate-password and I used length of 64 characters for our token. Hopefully this justification combined with the code below shines some light onto why the <code>Users</code> model had <code>reset_password_token</code> parameter.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="_images/reset-password-activity-screen.png" alt="reset password activity screen">
</div>
<div class="title">Figure 25. Reset password and send email user flow design</div>
</div>
<div class="paragraph">
<p>So go ahead and install this password generator</p>
</div>
<div class="listingblock">
<div class="title">Install password-generator library</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">npm install --save generate-password</code></pre>
</div>
</div>
<div class="paragraph">
<p>After that, we can begin working on our logic. So go ahead, install the password generator in your code and start coding the business logic for the <code>POST</code> request to <code>/users/forgot</code> route :</p>
</div>
<div class="listingblock">
<div class="title">routes/users.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">...
const passGenerator = require('generate-password');
...
router.post('/forgot', csrfProtection, async (req, res, next) =&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
  const { email } = req.body;
  if (email) {
    try {
      const user = await User.findOne({ where: { email: `${email}` } });
      if (user) {
        const _pd = passGenerator.generate({ length: 64, numbers: true }); <i class="conum" data-value="2"></i><b>(2)</b>
        user.reset_password_token = _pd;
        await user.save(); <i class="conum" data-value="3"></i><b>(3)</b>
        // send email async
        const msg = {
          to: `${user.email}`,
          from: `alex.kluew@gmail.com`,
          subject: 'Elderoost : Password Reset',
          text: `To reset your password, please go to https://elderoostalpha.herokuapp.com/users/forgot/t/${_pd}`, <i class="conum" data-value="4"></i><b>(4)</b>
          html: `&lt;strong&gt;To reset your password, please go to &lt;a 										 href="https://elderoostalpha.herokuapp.com/users/forgot/t/${_pd}"&gt;https://elderoostalpha.herokuapp.com/users/forgot/t/${_pd}&lt;/a&gt;&lt;/strong&gt;`
        };
        await sgMail.send(msg);	<i class="conum" data-value="5"></i><b>(5)</b>
        res.render('users/forgot-after');
      }
    } catch (e) {
      console.error(`ERRROR in POST /users/forgot : ${e}`);
    }
  }
});
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Csrf protection</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>After we found the user, generate a new reset password token</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set the <code>reset_password_token</code> and save the user</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set the password token in the url for the user to visit</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Send the email with <code>msg</code> content to <code>user.email</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we go ahead and create the after template that is going to be redirected to on a successful reset in <code>views/users/forgot-after.hbs</code>:</p>
</div>
<div class="listingblock">
<div class="title">views/users/forgot-after.hbs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;section class="main main-text-wrapper"&gt;
  &lt;div class="main__wrapper-purple padding-left padding-right"&gt;
    &lt;h1 class="main__wrapper-purple__text"&gt;&lt;i class="fa fa-redo" aria-hidden="true"&gt;&lt;/i&gt; Reset password&lt;/h1&gt;
  &lt;/div&gt;
  &lt;div class="main__wrapper main__negative-top-margin"&gt;
    &lt;div class="padding-left padding-right padding-top padding-bottom"&gt;
      &lt;p style="text-align:center;"&gt;If the email exists, we will reset your password and send an email with instructions
        for creating a new
        password.&lt;/p&gt; <i class="conum" data-value="1"></i><b>(1)</b>
      &lt;p style="text-align:center;font-weight:100;"&gt;Go back &lt;a href="/?ref=forgot" class="main__wrapper__link"&gt;home&lt;/a&gt;.
      &lt;/p&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/section&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Friendly message to the user that the password was reset if the email exists (it wasn&#8217;t as we set a reset token and not actually reset the password).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Okay, so now the user can visit a page, submit an email to receive a reset token in, view instructions page after submission, and receive a password reset token in email.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/email-reset-password-screen.png" alt="Reset password email link">
</div>
<div class="title">Figure 26. Reset password email with reset password link</div>
</div>
<div class="paragraph">
<p>If you were wondering, this is what the email looks like that was sent by our app. Notice that SendGrid changes your URL in the email and adds its own data. However, when a user clicks on the link then they get redirected exactly where the code tells them to go.</p>
</div>
<div class="paragraph">
<p>Next, we need to proceed in creating the router handler for the token password reset, <code>/users/forgot/t/:token</code>.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="_images/email-reset-token-activity-screen.png" alt="email reset token activity screen">
</div>
<div class="title">Figure 27. User activity flow design for accessing set new password screen</div>
</div>
<div class="paragraph">
<p>I did this by creating a route that takes the token itself as one of the parameters to access the reset password page. Thus, a random user cannot access our password reset page. The page is only accessible via an email. So, if a user enters the correct token then they will access the password reset page for that token. Lets build this out by creating first a get route, followed by creating the reset password template.</p>
</div>
<div class="listingblock">
<div class="title">routes/users.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">router.get('/forgot/t/:token', csrfProtection, async (req, res, next) =&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
  const { token } = req.params;
  if (token &amp;&amp; token.length === 64) {
    try {
      const user = await User.findOne({
        where: { reset_password_token: `${token}` } <i class="conum" data-value="2"></i><b>(2)</b>
      });

      if (user) {
        res.render('users/forgot-token', { <i class="conum" data-value="3"></i><b>(3)</b>
          title: `Set new password - Elderoost`,
          token: token, <i class="conum" data-value="4"></i><b>(4)</b>
          csrfToken: req.csrfToken()
        });
      }
    } catch (e) {
      console.error(`ERROR in /forgot/t/:token : ${e}`);
    }
  }
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Add csrf protection as we will be displaying the reset password form</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The only way to access this page is with a token and the only way to get this token is from the `User&#8217;s email inbox. I look for the user with this token.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Once the user is found with the reset token, we redirect the user to the <code>views/users/forgot-token.hbs</code> template</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>I pass the token to be used by our reset password form</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As you can notice, I pass the token to the next template that I will be displaying, <code>forgot-token.hbs</code>, which is the password reset form. In the form, I will use this token in a way that you will see below. Then, I will ask ask the user to confirm the email for which the password will be reset along with the new password. This way, before resetting any password and doing damage to a user’s experience, I need to receive the email and the password reset token from the user. So, the code form for the password reset form will look something like this</p>
</div>
<div class="listingblock">
<div class="title">views/users/forgot-token.hbs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;section class="main main-text-wrapper"&gt;
  &lt;div class="main__wrapper-purple padding-left padding-right"&gt;
    &lt;h1 class="main__wrapper-purple__text"&gt;&lt;i class="fa fa-search" aria-hidden="true"&gt;&lt;/i&gt; Reset password&lt;/h1&gt;
  &lt;/div&gt;
  &lt;div class="main__wrapper main__negative-top-margin"&gt;
    &lt;div class="padding-left padding-right padding-top padding-bottom"&gt;
      &lt;form action="/users/forgot/t/{{token}}" method="POST"&gt; <i class="conum" data-value="1"></i><b>(1)</b>
        &lt;input type="hidden" name="_csrf" value="{{csrfToken}}"&gt; <i class="conum" data-value="2"></i><b>(2)</b>
        &lt;div class="field"&gt;
          &lt;label class="label" for="email"&gt;Email&lt;/label&gt; <i class="conum" data-value="3"></i><b>(3)</b>
          &lt;div class="input-wrapper"&gt;
            &lt;input id="email" name="email" type="email" class="input" required spellcheck="false" autocomplete="off"&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class="field"&gt;
          &lt;label class="label" for="password"&gt;New Password&lt;/label&gt;
          &lt;div class="input-wrapper"&gt;
            &lt;input id="password" name="password" type="password" class="input" required spellcheck="false"
              autocomplete="off"&gt;
            &lt;p class="help"&gt;Enter your new password.&lt;/p&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;button class="button is-primary full-width" type="submit"&gt;Set new password&lt;/button&gt;
      &lt;/form&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/section&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>There will be a route handler waiting for a <code>POST</code> request for the URL that contains the reset password token</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Add csrf protection for our reset password form</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Ask for the user&#8217;s email once again to confirm during the next step</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That code looks like this</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/new-password-screen.png" alt="New password screen">
</div>
<div class="title">Figure 28. New password screen accessed via a link in a password reset email</div>
</div>
<div class="paragraph">
<p>Now, lets move on to building the <code>POST</code> router handler that will be responsible for processing this form, resetting to a new password, and sending an email to the user stating that their password was recently reset.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="_images/set-password-activity-screen.png" alt="set password activity screen">
</div>
<div class="title">Figure 29. Set new password activity flow design</div>
</div>
<div class="listingblock">
<div class="title">routes/users.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">router.post('/forgot/t/:token', csrfProtection, async (req, res, next) =&gt; {
  const { token } = req.params;
  const { email, password } = req.body;
  if (token &amp;&amp; token.length === 64) {
    if (email &amp;&amp; password) {
      try {
        const user = await User.findOne({
          where: {
            email: email,
            reset_password_token: token,
          },
        });
        if (user) {
          const hash = await bcrypt.hash(password, saltRounds);
          user.password = hash;
          user.reset_password_token = '';
          await user.save();
          // send email async
          const msg = {
            to: `${user.email}`,
            from: `alex.kluew@gmail.com`,
            subject: 'Elderoost : Password was reset.',
            text: `Hello, your password was recently reset. If you did recently reset your password, then please disregard this message. Otherwise, please contact us at alex.kluew@gmail.com about this email.`,
            html: `Hello, your password was recently reset. If you did recently reset your password, then please disregard this message. Otherwise, please contact us at alex.kluew@gmail.com about this email.`,
          };
          await sgMail.send(msg);
          res.redirect(`/users/signin?ref=password-reset`);
        }
      } catch (e) {
        console.error(`ERROR in /forgot/t/:token : ${e}`);
      }
      res.redirect(`/forgot/t/${token}`);
    }
  }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>In case you were wondering this is what the email looks like this once the password was reset successfully :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/email-password-was-reset.png" alt="Password was reset email notification">
</div>
<div class="title">Figure 30. Password was reset email notification screen</div>
</div>
<div class="paragraph">
<p>We used the <code>bcrypt</code> library to generate a new password hash using the newly provided password by the password reset form. In addition, I reset the value of the <code>reset_password_token</code> such that this function is only ran once and the token is reset after its use. After a successful password reset, I send an email to the user notifying them that their password was recently reset. It is a good security practice to send such an email to the user. Worst case scenario they get an additional email from you that they can delete or in a best case the user sees a password change that they did not initiate. Following the sent email using SendGrid, I redirect the user into the login page so that they can login to their account using their newly set password. If the password was not successful, I simply redirect the user back to the set new password form.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_user_profiles"><a class="anchor" href="#_user_profiles"></a>24. User profiles</h2>
<div class="sectionbody">
<div class="paragraph">
<p>User profiles in our case are meant to be a starting place. It was deliberately decided into the construction of the user requirements that a user could not change an email address by themselves. It is our one rule in the application. Thus, if a user is requesting an email change they must go through the proper contact us channels.</p>
</div>
<div class="paragraph">
<p>A user can, however, change their username and password. The password change is currently implemented via the password reset form. Whereas, the username can be changed via the profile screen.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/profile-screen.png" alt="User profile screen">
</div>
<div class="title">Figure 31. Completed user profile screen</div>
</div>
<div class="paragraph">
<p>Head over and create the following route handler</p>
</div>
<div class="listingblock">
<div class="title">routes/users.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">...
router.get('/profile', csrfProtection, (req, res, next) =&gt; {
  if (req.user) { <i class="conum" data-value="1"></i><b>(1)</b>
    res.render('users/profile', {
      title: `My profile - Elderoost`,
      csrfToken: req.csrfToken(),
    });
  } else {
    res.redirect('/users/signin');
  }
});
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Check that the user object is there before loading the template</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>and then go ahead and create the template for the profile screen</p>
</div>
<div class="listingblock">
<div class="title">views/users/profile.hbs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;section class="main main-text-wrapper"&gt;
  &lt;div class="main__wrapper-purple padding-left padding-right"&gt;
    &lt;h1 class="main__wrapper-purple__text"&gt;Profile
    &lt;/h1&gt;
  &lt;/div&gt;
  &lt;div class="main__wrapper main__negative-top-margin"&gt;
    &lt;div class="padding-left padding-right padding-top padding-bottom"&gt;
      &lt;form action="/users/profile" method="POST"&gt; <i class="conum" data-value="1"></i><b>(1)</b>
        &lt;input type="hidden" name="_csrf" value="{{csrfToken}}"&gt; <i class="conum" data-value="2"></i><b>(2)</b>
        &lt;div class="field"&gt;
          &lt;label class="label" for="username"&gt;Username&lt;/label&gt;
          &lt;div class="input-wrapper"&gt;
            &lt;input id="username" name="username" type="text" class="input" required spellcheck="false"
              autocomplete="off" value={{user.username}}&gt; <i class="conum" data-value="3"></i><b>(3)</b>
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class="field"&gt;
          &lt;label class="label" for="email"&gt;Email&lt;/label&gt;
          &lt;div class="input-wrapper"&gt;
            &lt;input id="email" name="email" type="email" class="input" required spellcheck="false" autocomplete="off" value={{user.email}} readonly&gt; <i class="conum" data-value="4"></i><b>(4)</b>
            &lt;p class="help"&gt;Your email cannot be changed. Please contact us to do that.&lt;/p&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class="field"&gt;
          &lt;label class="label" for="password"&gt;Password&lt;/label&gt;
          &lt;div class="input-wrapper"&gt;
            &lt;input id="password" name="password" type="password" class="input" required spellcheck="false" autocomplete="off"&gt; <i class="conum" data-value="5"></i><b>(5)</b>
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;button class="button is-primary full-width" type="submit"&gt;Save &lt;i class="fa fa-save"
            aria-hidden="true"&gt;&lt;/i&gt;&lt;/button&gt;
      &lt;/form&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/section&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Route handler that we will have to build to handle this form&#8217;s <code>POST</code> request to <code>/users/profile</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>csrf token</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>User data gathered from session data and can change their username</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Email is in a read-only mode and cannot be changed</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Require a password for the change to be implemented</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As you can see above, our <code>user</code> object appeared somehow magically?! It was passed on to the template through the code in our session data. More specifically, we have the code <code>req.locals.user</code> and <code>req.user</code> objects that has the data that we need to display in our user profile template.</p>
</div>
<div class="paragraph">
<p>What is left over after displaying the template is to build the route handlers that will process the changes requested in our user profile form. Let&#8217;s head over and build that code</p>
</div>
<div class="listingblock">
<div class="title">routes/users.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">...
router.post('/profile', csrfProtection, async (req, res, next) =&gt; {
  const { username, email, password } = req.body;
  if (username &amp;&amp; email &amp;&amp; password) {
    // all good we can change the username
    const user = await User.findOne({ where: { email: `${email}` } }); <i class="conum" data-value="1"></i><b>(1)</b>
    if (user) {
      const compare = await bcrypt.compare(password, user.password); <i class="conum" data-value="2"></i><b>(2)</b>
      if (compare) {
        if (user.username !== username) {
          const _usernameExists = await User.findOne({
            where: { username: `${username}` },
          }); <i class="conum" data-value="3"></i><b>(3)</b>
          if (!_usernameExists) {
            const updatedUser = await User.update(
              { username: username },
              { where: { email: `${email}` } }
            ); <i class="conum" data-value="4"></i><b>(4)</b>
          }
        }
      }
      res.redirect('/users/profile');
    } else {
      res.redirect('/users/logout');
    }
  }
});
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Find the user by email</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Check that the password for the user is correct</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Check that there are no other users with the same username</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Change the username for the user with the provided email address</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now, we have implemented all of the features to have a successful user with a user account. We, also, have built enough automation so a user can reset their passwords and change usernames without me having to intervene. Small wins that you can automate for the user are always a good idea to invest time into.</p>
</div>
</div>
</div>
<h1 id="_deployment" class="sect0"><a class="anchor" href="#_deployment"></a>Deployment</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Now that you are happy with your project and how it behaves on your local environment, you are probably looking for a way to share your project with the public. In this chapter, I will be going over the various tools and procedures that are available to you. However, I will focus on deploying our project to the <a href="https://heroku.com">heroku</a> platform.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">development </dt>
<dd>
<p>synonymous with application being worked on state; usually not used by the public and worked on locally</p>
</dd>
<dt class="hdlist1">production </dt>
<dd>
<p>synonymous with application being in the state that is being served to public and used by customers</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The deployment also depends on each project and the access to funds available. There are free solutions available that are perfect for small projects. However, once you start working with real projects, cost will have to play a factor in deciding how to deploy your application to production stage. Moreover, the cost and skills required to run the infastructure should also play a role.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ngrok_com"><a class="anchor" href="#_ngrok_com"></a>25. ngrok.com</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You know how you cannot just easily share your <code><a href="http://localhost:3000" class="bare">http://localhost:3000</a></code> project link with someone? You need to play with your system settings or your router setup. It can be a hassle and time consuming; and this is where ngrok shines.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="_images/localhost-ngrok-client.png" alt="localhost ngrok client">
</div>
<div class="title">Figure 32. Ngrok acts like a middleman between your local code and whoever you share the link with</div>
</div>
<div class="paragraph">
<p>Ngrok is a wonderful step before production deployment. What ngrok allows you to do is to create a sharerable link that proxies to your local environment. All you have to do is register for the tool and pick the plan that you want to use. I recommend the free tier for testing purposes.</p>
</div>
<div class="paragraph">
<p>Then you download their command line interface tool, as described on their website, and just run it. Once you are ready to share a working application, start the server on <code>localhost</code> and remember the <code>port</code>. When everything is running, run ngrok tool over the port that the application is running. That is all. Ngrok will do all of its magic for you and give you a link to share with your users or clients.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_heroku"><a class="anchor" href="#_heroku"></a>26. Heroku</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Deploying your project to heroku is one of the fastest and easiest solutions available out there. Heroku empowers you and enables you to focus on just your project. Why is that a big deal? Before running our node.js project, a server needs to be provisioned and setup. This takes time and resources. Only after the server and the environment is setup, then you can create some deployment procedure.</p>
</div>
<div class="paragraph">
<p>Whereas, in heroku all you have to do is deploy and the platform focuses on the server part. This is obviously a trade off. Heroku has done a lot of work in the background to make this as easy as possible for end users and timely. For this, they charge a fee and this is how they make their money.</p>
</div>
<div class="paragraph">
<p>While your project is small, and while you scale, heroku is a viable resource and a timesaver. But, I should mention that sooner or later you will need to look at server skills or hiring someone. Why? Cost. As your project scales on heroku, you will need more resources to make everything run smoothly. At one point you will notice that some things could be done cheaper, if the knowledge is there. So it is a trade off.</p>
</div>
<div class="paragraph">
<p>Heroku not only shines at its ease and time saving, but also in integrating with many add-ons and platforms. They make adding beautiful logging service, a database, or a mailer (among many other things) with a click of a button and some ready-to-paste code. They really made their platform wonderful and hard to switch away from.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Git</div>
<div class="paragraph">
<p>Heroku and their tools require that git is installed on your system before fully working. If this is a problem then heroku may not be a suitable solution. However, I recommend that you spend some time learning git and, ultimately, github. Don&#8217;t be afraid to just give it a shot. You only need basic knowledge in order for everything to run.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So in order to deploy our project on heroku, you need to set everything up locally. You can read about the setup process on heroku&#8217;s website located here : <a href="https://devcenter.heroku.com/articles/getting-started-with-nodejs" class="bare">https://devcenter.heroku.com/articles/getting-started-with-nodejs</a> Just substitude our project for the example code provided in the tutorial and everything should work. After running through the setup, our project was uploaded to heroku, heroku processed it, and finally it ran <code>node app.js</code>; which started our application.</p>
</div>
<div class="paragraph">
<p>The next time you want do adjust your code and see it reflected you will only have to add your project to a latest git commit and type <code>git push heroku master</code>. Everything else will just work.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="_images/git-heroku-process.png" alt="git heroku process">
</div>
<div class="title">Figure 33. Coding with git and heroku overview</div>
</div>
<div class="paragraph">
<p>However, nowhere in the chapter so far have we properly finished configuring our production setup. We got our code to be deployed to heroku. Heroku ran our code. But, where is our PostgreSQL database for example? Our application cannot work without a database.</p>
</div>
<div class="paragraph">
<p>This is where heroku shines. Open your browser, head over to heroku, login, and find your project. Once you click on your project, heroku will bring you to your project&#8217;s dashboard. In the dashboard, look for an addons section and click <code>Configure Add-ons</code></p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="_images/heroku-dashboard.png" alt="Configure add-ons feature on heroku project&#8217;s dashboard">
</div>
<div class="title">Figure 34. Configure add-ons feature on heroku project&#8217;s dashboard</div>
</div>
<div class="paragraph">
<p>Then, from the addons you will need to find the following two addons :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Heroku Postgres</p>
</li>
<li>
<p>Papertrail</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These two add-ons are the minimum that I recommend for a project. Postgres is, hopefully, self-explanatory in that it adds postgreSQL to your project. Moreover, heroku sets up an environmental variable called <code>DATABASE_URL</code> with the value to connect to this newly provisioned database.</p>
</div>
<div class="paragraph">
<p>If you recall during our <a href="sequelize.js.html#database-setup" class="page">database setup</a>, we had an if statement that looked like this :</p>
</div>
<div class="listingblock">
<div class="title">config/db.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">if (process.env.NODE_ENV === 'production') {
  database = `${process.env.DATABASE_URL}`;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hopefully you can now understand why I specifically put this code in there.</p>
</div>
<div class="paragraph">
<p>Meanwhile, I recommend to install the optional <code>Papertrail</code> plugin. It is a wonderful plugin to look at your errors while you develop. You can see everything that your main node.js process sees using this tool. For more robust logging tool, I would recommend something like <code>Rollbar</code>.</p>
</div>
<div class="paragraph">
<p>Finally, as I mentioned in the introduction to heroku, the platform has a very generous free tier. Then you can pay additional fees as you scale and the need for resources grows.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_server"><a class="anchor" href="#_server"></a>27. Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The most popular way to deploy applications is by the use of your own server. The biggest downside, if you consider it a down side of course, is that you have to do everything yourself or outsource that to someone. On the whole, there is a steep learning curve to server configuration and setup. However, the process is replicated once you learn it. If the knowledge is not necessary I still think this section is beneficial to read as I give a general overview.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Don&#8217;t forget about back-up services and redundancies. Once you begin growing, considering having at least three copies of a resource. Good rule of thumbs to have.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For deploying of your server there are several solutions :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Colocation</p>
</li>
<li>
<p>In the cloud</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_colocation"><a class="anchor" href="#_colocation"></a>27.1. Colocation</h3>
<div class="paragraph">
<p>Colocation&#8201;&#8212;&#8201;you rent physical space and put your physical server in a building that is usually called a data center. This space may be local or you may have to travel to it. Depending on your resources available. However, you would want your server to have good resources such that you can serve your customers as fast as possible.</p>
</div>
<div class="paragraph">
<p>Sometimes these data centers have specific hardware that they sell, other times you may be required to build and bring the computer yourself.</p>
</div>
</div>
<div class="sect2">
<h3 id="_cloud"><a class="anchor" href="#_cloud"></a>27.2. Cloud</h3>
<div class="paragraph">
<p>In the cloud, or in other words, renting your server resources from someone who is selling their hardware. This is usually, once again, done by the data providers like Linode and major software companies like Amazon Web Services, Google Cloud, Microsoft Azure. The only difference is the type of data center that it is. Otherwise, some data centers allow for both renting of physical hardware and of virtually allocated hardware.</p>
</div>
<div class="paragraph">
<p>This is the most common solution. People rent virtually allocated machines and then set them up as they need them.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Remember, the more control you have about your infastructure the more risk you take for the running of the application(s). Think about redundancies and back-ups.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_running_server"><a class="anchor" href="#_running_server"></a>27.3. Running Server</h3>
<div class="paragraph">
<p>Once you get everything running on a server, you will move into the maintenance phase of this current project. There will be a need to know when the application crashes or if the server goes down for some reason. It is probably a good idea for your server to use some 3rd party health check tool. You will want to be on top of your crashes so that your users experience the minimum amount of down time.</p>
</div>
<div class="paragraph">
<p>I would argue that you should have a health check for each of the major components of your application. In our case, that is the express server and the postgresql database. In production, I would want to know the health state for both of these components. This means additional code that needs to be built.</p>
</div>
<div class="paragraph">
<p>Then you should think about back-ups and the frequency of these back-ups. In our case, the only data that we have that is important is located inside the PostgreSQL database. Fortunately for  us, PostgreSQL has a tool that allows for an export and import of data. So, I would run and export a copy of our data at least once a day. Usually, I use a time stamp for the filenames just for future readibility.</p>
</div>
<div class="paragraph">
<p>Don&#8217;t forget to have at least several copies of your daily backups. I recommend at least three copies of the data located in three different places: (1) hard drive, (2) external hard drive, and (3) cloud.</p>
</div>
<div class="paragraph">
<p>In addition you would want to use some kind of third party service for your error notifications. When picking on a provider, I would look at the different notification mechanisms that they have in place. Some of them even notify you when an error occurs via sms.</p>
</div>
<div class="sect3">
<h4 id="_healthcheck_of_server"><a class="anchor" href="#_healthcheck_of_server"></a>27.3.1. Healthcheck of Server</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Healthcheck is a feature in your application that allows  you to monitor the state of your application while you are away by some 3rd party service (or a service of your own placed in a different location).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We would like to have a route on our project that has only one function : to respond to requests with a message that says I am online and everything is working. Usually it goes something like this :</p>
</div>
<div class="listingblock">
<div class="title">.app.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">...
app.use(`/status`, (req, res, next) =&gt; {
  res.status(200).send({ status: `OK` }); <i class="conum" data-value="1"></i><b>(1)</b>
});
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The actual response varies according to the 3rd party service that you use</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The 3rd party service calls on this route on a regular basis. The function of the 3rd party service is to notify you in an event that the server does not respond with a proper message. Then the service would send you some kind of notification to say that your service did not respond in an expected manner.</p>
</div>
</div>
<div class="sect3">
<h4 id="_healthcheck_of_databases"><a class="anchor" href="#_healthcheck_of_databases"></a>27.3.2. Healthcheck of Databases</h4>
<div class="paragraph">
<p>Similarly to the server, you would like to know that your database (PostgreSQL in our instance) is working properly. Luckily, we can do that with the <code>authenticate</code> function that is provided to us with sequelize module. Our database healthcheck would look something like this</p>
</div>
<div class="listingblock">
<div class="title">.app.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">...
app.use(`/status/database`, (req, res, next) =&gt; {
  sequelize
    .authenticate()
    .then(() =&gt; {
      res.status(200).send({ status: `OK` }); <i class="conum" data-value="1"></i><b>(1)</b>
    })
    .catch((err) =&gt; {
      res.status(500).send({ status: `NOT OK` });
    });
});
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The actual response varies according to the 3rd party service that you use</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_server_setup_checklist"><a class="anchor" href="#_server_setup_checklist"></a>27.4. Server setup checklist</h3>
<div class="paragraph">
<p>Basic checklist to get our node.js application running on a server.</p>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p><i class="fa fa-square-o"></i> Buy server</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Pick Ubuntu distro</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Setup ssh</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Setup ssh login over ssh-key and not via password</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Create an <code>admin</code> user</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Remove remote <code>root</code> access</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Setup Node.js environment as per <a href="https://nodejs.org/en/" class="bare">https://nodejs.org/en/</a></p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Setup PostgreSQL</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Create cron job to backup database daily</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Create local cron job to download these backups</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Setup Nginx</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Setup HTTPS / SSL</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Setup <code>systemd</code> to run Node.js project</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Setup Cloudflare</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Setup Health Status Route</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Find a way to sync local project and server (git works or rsync)</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. see <a href="https://en.wikipedia.org/wiki/Cross-site_request_forgery" class="bare">https://en.wikipedia.org/wiki/Cross-site_request_forgery</a> or <a href="https://owasp.org/www-community/attacks/csrf" class="bare">https://owasp.org/www-community/attacks/csrf</a>
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. TablePlus software is great and it is available on Mac, Windows, and Linux platforms.
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
